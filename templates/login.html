{% extends "base.html" %} 
{% block title %}Login - CoChain.ai{% endblock %} 

{% block content %}
<!-- Custom CSS for Shooting Stars & Animations -->
<style>
  /* Night Sky Background */
  .night-sky-bg {
    background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
  }

  /* Star styling */
  .star {
    position: absolute;
    top: 50%;
    left: 50%;
    height: 2px;
    background: linear-gradient(-45deg, #5f91ff, rgba(0, 0, 255, 0));
    filter: drop-shadow(0 0 6px #699bff);
    animation: tail 3000ms ease-in-out infinite, shooting 3000ms ease-in-out infinite;
    opacity: 0;
    z-index: -1;
  }

  /* The glowing head of the star */
  .star::before {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* The trail of the star */
  .star::after {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* Animations */
  @keyframes tail {
    0% { width: 0; }
    30% { width: 100px; }
    100% { width: 0; }
  }

  @keyframes shooting {
    0% { transform: translateX(0); }
    100% { transform: translateX(300px); }
  }

  @keyframes shining {
    0% { width: 0; }
    50% { width: 30px; }
    100% { width: 0; }
  }
  
  /* Twinkling static stars */
  .static-star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--duration) ease-in-out infinite;
    opacity: var(--opacity);
  }
  
  @keyframes twinkle {
    0%, 100% { opacity: var(--opacity); transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
  }
</style>

<!-- BACKGROUND CONTAINER (Fixed position, behind everything) -->
<div class="fixed inset-0 night-sky-bg overflow-hidden pointer-events-none" style="z-index: -1;">
  <div id="star-container"></div>
  <div id="static-star-container"></div>
</div>

<!-- MAIN CONTENT WRAPPER -->
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative z-10">
  <div class="max-w-sm w-full">
    
    <!-- Logo and Title -->
    <div class="text-center mb-8">
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-glow">
            <i class="fas fa-link text-white text-3xl"></i>
        </div>
      </div>
      <h2 class="text-3xl font-light text-white mb-2">
        Sign in to CoChain.ai
      </h2>
    </div>

    <!-- Login Form Card -->
    <div class="bg-white/95 backdrop-blur-sm rounded-md shadow-xl border border-gray-200 p-6 sm:p-8 relative">
      <form id="login-form" method="POST" action="{{ url_for('login') }}">
        <!-- Email -->
        <div class="mb-4">
          <label class="block text-gray-900 font-bold text-sm mb-2">
            Email address
          </label>
          <input
            type="email"
            name="email"
            id="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm bg-white"
            placeholder="name@example.com"
          />
        </div>

        <!-- Password -->
        <div class="mb-6">
          <label class="block text-gray-900 font-bold text-sm mb-2">
            Password
          </label>
          <div class="relative">
            <input
              type="password"
              name="password"
              id="password"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm bg-white"
            />
            <button
              type="button"
              onclick="togglePassword()"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600 focus:outline-none"
            >
              <i id="password-icon" class="far fa-eye"></i>
            </button>
          </div>
          <div class="mt-2 text-right">
            <a
              href="#"
              class="text-xs text-blue-600 hover:text-blue-800 hover:underline font-semibold"
            >
              Forgot password?
            </a>
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="w-full bg-green-600 text-white px-4 py-2.5 rounded-md font-bold hover:bg-green-700 transition shadow-md hover:shadow-lg hover:-translate-y-0.5 transform border border-green-700"
        >
          Sign in
        </button>
      </form>
    </div>

    <!-- Register Link Box -->
    <div class="mt-6 p-4 border border-gray-500/30 rounded-md text-center bg-white/95 backdrop-blur-sm shadow-md">
      <span class="text-sm text-gray-700">New to CoChain?</span>
      <a
        href="{{ url_for('register') }}"
        class="text-sm text-blue-600 hover:text-blue-800 hover:underline ml-1 font-semibold"
      >
        Create an account
      </a>
    </div>

    <!-- Footer Links -->
    <div class="mt-8 flex justify-center space-x-4 text-xs text-gray-400">
      <a href="#" class="hover:text-white hover:underline transition">Terms</a>
      <a href="#" class="hover:text-white hover:underline transition">Privacy</a>
      <a href="#" class="hover:text-white hover:underline transition">Security</a>
      <a href="#" class="hover:text-white hover:underline transition">Contact GitHub</a>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>
{% endblock %} 

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      createShootingStars(); 
  });

  /**
   * Create Shooting Stars Background Effect
   */
  function createShootingStars() {
      const starContainer = document.getElementById('star-container');
      const staticContainer = document.getElementById('static-star-container');
      const starCount = 15;
      const staticCount = 50;
      
      // 1. Create Shooting Stars
      for (let i = 0; i < starCount; i++) {
          const star = document.createElement('span');
          star.className = 'star';
          const top = Math.random() * 100;
          const left = Math.random() * 100;
          const delay = Math.random() * 5000;
          const duration = 3000 + Math.random() * 3000;
          star.style.top = top + '%';
          star.style.left = left + '%';
          star.style.width = (Math.random() * 100 + 100) + 'px';
          star.style.animationDelay = delay + 'ms';
          star.style.animationDuration = duration + 'ms';
          star.style.transform = 'rotateZ(45deg)';
          starContainer.appendChild(star);
      }

      // 2. Create Static Twinkling Stars
      for (let i = 0; i < staticCount; i++) {
          const dot = document.createElement('div');
          dot.className = 'static-star';
          const size = Math.random() * 2 + 1;
          dot.style.width = size + 'px';
          dot.style.height = size + 'px';
          dot.style.top = Math.random() * 100 + '%';
          dot.style.left = Math.random() * 100 + '%';
          dot.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
          dot.style.setProperty('--opacity', Math.random() * 0.5 + 0.1);
          staticContainer.appendChild(dot);
      }
  }

  function togglePassword() {
    const passwordInput = document.getElementById("password");
    const passwordIcon = document.getElementById("password-icon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      passwordIcon.classList.remove("fa-eye");
      passwordIcon.classList.add("fa-eye-slash");
    } else {
      passwordInput.type = "password";
      passwordIcon.classList.remove("fa-eye-slash");
      passwordIcon.classList.add("fa-eye");
    }
  }

  // Toast Function
  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'transform transition-all duration-300 translate-x-full mb-4';
      let bgColor = 'bg-green-600'; 
      let icon = 'fa-check-circle';

      if (type === 'error') {
          bgColor = 'bg-red-600'; icon = 'fa-exclamation-circle';
      }

      toast.innerHTML = `
          <div class="${bgColor} text-white px-6 py-3 rounded-md shadow-lg flex items-center space-x-3 border border-transparent">
              <i class="fas ${icon}"></i>
              <span class="font-medium text-sm">${message}</span>
          </div>
      `;
      container.appendChild(toast);
      setTimeout(() => { toast.classList.remove('translate-x-full'); }, 10);
      setTimeout(() => {
          toast.classList.add('translate-x-full');
          setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
  }

  // Loading helpers
  function showLoading() {
      const btn = document.querySelector('button[type="submit"]');
      if(btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Signing in...';
      }
  }

  function hideLoading() {
      const btn = document.querySelector('button[type="submit"]');
      if(btn) {
          btn.disabled = false;
          btn.innerHTML = 'Sign in';
      }
  }

  // Form Submission Logic
  document
    .getElementById("login-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      showLoading();

      const formData = new FormData(this);
      const data = {
        email: formData.get("email"),
        password: formData.get("password"),
      };

      // Validate inputs
      if (!data.email || !data.password) {
        hideLoading();
        showToast("Please enter both email and password", "error");
        return;
      }

      console.log("ðŸ” Attempting login for:", data.email);

      fetch('{{ url_for("login") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => {
          console.log("ðŸ“¡ Login response status:", response.status);
          return response.json();
        })
        .then((data) => {
          console.log("ðŸ“ Login response data:", data);
          hideLoading();

          if (data.success) {
            console.log("âœ… Login successful, redirecting to:", data.redirect);
            showToast(data.message || "Login successful!", "success");
            setTimeout(() => {
              window.location.href =
                data.redirect || '{{ url_for("dashboard") }}';
            }, 1000);
          } else {
            console.log(
              "âŒ Login failed:",
              data.error,
              "Type:",
              data.error_type
            );

            // Show specific error messages
            let errorMessage = data.error || "Login failed";
            let toastType = "error";

            if (data.error_type === "invalid_credentials") {
              errorMessage = "Incorrect username or password.";
            } else if (data.error_type === "missing_credentials") {
              errorMessage = "Please enter both email and password.";
            }

            showToast(errorMessage, toastType);
          }
        })
        .catch((error) => {
          console.error("ðŸ’¥ Login request failed:", error);
          hideLoading();
          showToast(
            "Network error. Please check your connection and try again.",
            "error"
          );
        });
    });
</script>
{% endblock %}