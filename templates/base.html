<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}CoChain.ai - AI-Powered Project Recommendations{%
      endblock %}
    </title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/webp"
      href="{{ url_for('static', filename='images/favicon.webp') }}"
    />

    <!-- PWA Manifest -->
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <!-- GitHub Dark Header Color -->
    <meta name="theme-color" content="#24292f" />

    <style>
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Helvetica, Arial, sans-serif;
      }

      /* GitHub-style Hover Card */
      .card-hover {
        transition: all 0.2s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-color: #d1d5db; /* gray-300 */
      }

      /* Navbar Dropdown */
      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        margin-top: 0.5rem;
        z-index: 9999;
        border: 1px solid #e5e7eb; /* gray-200 */
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown {
        position: relative;
      }

      .dropdown:hover .dropdown-menu {
        display: block;
      }

      .dropdown::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        height: 0.5rem;
        z-index: 9998;
      }

      /* Mobile Menu Styles */
      #mobile-menu {
        overflow: hidden;
      }

      /* Override md:hidden when menu is shown */
      @media (max-width: 767px) {
        #mobile-menu[style*="display: block"] {
          display: block !important;
        }
      }

      /* Loading animation */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>
  <body class="bg-gray-50 text-gray-900">
    <!-- Navigation - GitHub Dark Header -->
    <nav class="bg-gray-900 text-white shadow-sm">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <i class="fas fa-link text-3xl"></i>
            <a
              href="/"
              class="text-xl font-bold hover:text-gray-300 transition tracking-tight"
              >CoChain.ai</a
            >
          </div>

          <!-- Desktop Navigation -->
          <div
            class="hidden md:flex items-center space-x-6 text-sm font-semibold"
          >
            {% if user_id %}
            <!-- Logged in user navigation -->
            <a
              href="{{ url_for('about') }}"
              class="hover:text-gray-300 transition"
              >About</a
            >
            <a
              href="{{ url_for('dashboard') }}"
              class="hover:text-gray-300 transition"
            >
              Dashboard
            </a>
            <a
              href="{{ url_for('explore') }}"
              class="hover:text-gray-300 transition"
            >
              Explore
            </a>
            <a
              href="{{ url_for('bookmarks') }}"
              class="hover:text-gray-300 transition"
            >
              Bookmarks
            </a>

            <!-- Notifications Link with Badge -->
            <a
              href="{{ url_for('notifications') }}"
              class="flex items-center space-x-1 hover:text-gray-300 transition relative"
            >
              <div class="relative">
                <i class="far fa-bell text-lg"></i>
                {% if unread_notifications_count > 0 %}
                <!-- Blue dot indicator (GitHub style) -->
                <span class="absolute -top-1 -right-1 flex h-2.5 w-2.5">
                  <span
                    class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500 border-2 border-gray-900"
                  ></span>
                </span>
                {% endif %}
              </div>
            </a>

            <!-- User Info Dropdown -->
            <div class="relative dropdown" id="userDropdown">
              <button
                id="userMenuButton"
                type="button"
                class="flex items-center space-x-2 hover:text-gray-300 transition"
              >
                <div
                  class="w-5 h-5 rounded-full bg-gray-700 border border-gray-600 flex items-center justify-center text-xs"
                >
                  <i class="fas fa-user"></i>
                </div>
                <span class="hidden lg:block">{{ user_name or 'User' }}</span>
                <i class="fas fa-caret-down text-xs text-gray-400"></i>
              </button>

              <!-- Dropdown Menu -->
              <div
                id="userMenuDropdown"
                class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl py-1 z-50 border border-gray-200"
              >
                <a
                  href="{{ url_for('my_projects') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                  My Projects
                </a>

                <div class="border-t border-gray-100 my-1"></div>

                <a
                  href="{{ url_for('profile_setup') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                  Your Profile
                </a>

                {% if is_admin %}
                <div class="border-t border-gray-100 my-1"></div>
                <div
                  class="px-4 py-1 text-xs font-semibold text-gray-500 uppercase"
                >
                  Admin
                </div>
                <a
                  href="{{ url_for('admin_analytics') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                  Analytics
                </a>
                <a
                  href="{{ url_for('admin_users') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                  Users
                </a>
                {% endif %}
                <div class="border-t border-gray-100 my-1"></div>
                <a
                  href="{{ url_for('logout') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                  Sign out
                </a>
              </div>
            </div>
            {% else %}
            <!-- Not logged in navigation -->
            <a
              href="{{ url_for('index') }}"
              class="hover:text-gray-300 transition"
            >
              Home
            </a>
            <a
              href="{{ url_for('about') }}"
              class="hover:text-gray-300 transition"
              >About</a
            >
            <a
              href="{{ url_for('login') }}"
              class="hover:text-gray-300 transition"
            >
              Sign In
            </a>
            <a
              href="{{ url_for('register') }}"
              class="border border-gray-100 text-white px-3 py-1.5 rounded-md hover:border-gray-300 hover:text-gray-200 transition font-semibold text-sm"
            >
              Sign Up
            </a>
            {% endif %}
          </div>

          <!-- Mobile Menu Button -->
          <button
            id="mobile-menu-btn"
            class="md:hidden focus:outline-none text-gray-300 hover:text-white z-50 p-2 -mr-2"
            aria-label="Toggle mobile menu"
            aria-expanded="false"
          >
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>

        <!-- Mobile Menu -->
        <div
          id="mobile-menu"
          class="md:hidden mt-4 pb-4 border-t border-gray-700 pt-4 space-y-2"
          style="display: none"
        >
          {% if user_id %}
          <!-- Logged in mobile menu -->
          <div class="py-2 px-2 mb-2 flex items-center space-x-2">
            <div
              class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs border border-gray-600"
            >
              <i class="fas fa-user"></i>
            </div>
            <span class="text-white font-semibold text-sm">
              {{ user_name or 'User' }}
            </span>
          </div>
          <a
            href="{{ url_for('dashboard') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Dashboard
          </a>
          <a
            href="{{ url_for('explore') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Explore
          </a>
          <a
            href="{{ url_for('my_projects') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            My Projects
          </a>
          <a
            href="{{ url_for('bookmarks') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Bookmarks
          </a>
          <a
            href="{{ url_for('notifications') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold relative"
          >
            <span>Notifications</span>
            {% if unread_notifications_count > 0 %}
            <span
              class="ml-2 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-500 rounded-full"
            >
              {{ unread_notifications_count }}
            </span>
            {% endif %}
          </a>
          <a
            href="{{ url_for('profile_setup') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Profile
          </a>
          {% if is_admin %}
          <div class="border-t border-gray-700 mt-2 pt-2 mx-2"></div>
          <div class="text-xs font-semibold text-gray-500 uppercase mb-2 px-2">
            Admin
          </div>
          <a
            href="{{ url_for('admin_analytics') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Analytics
          </a>
          <a
            href="{{ url_for('admin_users') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Users
          </a>
          {% endif %}
          <a
            href="{{ url_for('logout') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition border-t border-gray-700 mt-2 pt-4 font-semibold"
          >
            <i class="fas fa-sign-out-alt mr-2"></i> Sign out
          </a>
          {% else %}
          <!-- Not logged in mobile menu -->
          <a
            href="{{ url_for('index') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Home
          </a>
          <a
            href="{{ url_for('login') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Sign In
          </a>
          <a
            href="{{ url_for('register') }}"
            class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300 hover:text-white transition font-semibold"
          >
            Sign Up
          </a>
          {% endif %}
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="container mx-auto px-4 mt-6">
      {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} 
        {% if category == 'success' %}bg-green-50 border-green-200 text-green-800{% endif %}
        {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% endif %}
        {% if category == 'info' %}bg-blue-50 border-blue-200 text-blue-800{% endif %}
        {% if category == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% endif %}
        border rounded-md px-4 py-3 relative mb-4 shadow-sm text-sm"
        role="alert"
      >
        <div class="flex items-center">
          {% if category == 'success' %}<i class="fas fa-check-circle mr-2"></i
          >{% endif %} {% if category == 'error' %}<i
            class="fas fa-times-circle mr-2"
          ></i
          >{% endif %} {% if category == 'info' %}<i
            class="fas fa-info-circle mr-2"
          ></i
          >{% endif %} {% if category == 'warning' %}<i
            class="fas fa-exclamation-triangle mr-2"
          ></i
          >{% endif %}
          <span class="block sm:inline font-medium">{{ message }}</span>
        </div>
        <button
          type="button"
          class="absolute top-0 bottom-0 right-0 px-4 py-3 opacity-50 hover:opacity-100"
          onclick="this.parentElement.remove()"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- Main Content -->
    <main>{% block content %}{% endblock %}</main>

    <!-- Footer - GitHub Light Style -->
    <footer class="bg-gray-100 text-gray-600 mt-16 border-t border-gray-200">
      <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center space-x-2 mb-4 md:mb-0">
            <i class="fas fa-link text-gray-400 text-2xl"></i>
            <span class="text-xs text-gray-500">&copy; 2025 CoChain.ai</span>
          </div>
          <div class="flex space-x-6 text-sm">
            <a
              href="{{ url_for('about') }}"
              class="hover:text-blue-600 hover:underline"
              >About</a
            >
            <a href="#" class="hover:text-blue-600 hover:underline">Terms</a>
            <a href="#" class="hover:text-blue-600 hover:underline">Privacy</a>
            <a href="#" class="hover:text-blue-600 hover:underline">Security</a>
            <a href="#" class="hover:text-blue-600 hover:underline">Status</a>
            <a href="#" class="hover:text-blue-600 hover:underline">Help</a>
          </div>
        </div>
        <div class="mt-4 text-center md:text-left">
          <p class="text-xs text-gray-500">
            AI-Powered Project Recommendations for Developers.
          </p>
        </div>
      </div>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-md shadow-xl border border-gray-200 p-6 flex items-center space-x-4"
      >
        <div
          class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-800"
        ></div>
        <span class="text-sm font-semibold text-gray-700">Processing...</span>
      </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <div
      id="app-data"
      data-user-id="{{ user_id if user_id else '' }}"
      data-user-name="{{ user_name if user_name else '' }}"
      data-is-admin="{{ 'true' if is_admin else 'false' }}"
      style="display: none"
    ></div>

    <!-- Scripts - Load in correct order -->
    <!-- 1. jQuery (if needed by other scripts) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 2. Event tracking -->
    <script src="{{ url_for('static', filename='js/event_tracking.js') }}"></script>

    <!-- 3. Main application JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- 4. Base template functionality -->
    <script>
      /**
       * Base template functionality
       */

      // Mobile menu toggle
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");

        console.log("Mobile menu elements:", { mobileMenuBtn, mobileMenu }); // Debug log

        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent event from bubbling
            e.preventDefault(); // Prevent default button behavior

            const isVisible = mobileMenu.style.display === "block";
            console.log(
              "Mobile menu button clicked, current state:",
              isVisible ? "visible" : "hidden"
            ); // Debug log

            // Toggle visibility using display property
            if (isVisible) {
              mobileMenu.style.display = "none";
              mobileMenuBtn.setAttribute("aria-expanded", "false");
            } else {
              mobileMenu.style.display = "block";
              mobileMenuBtn.setAttribute("aria-expanded", "true");
            }

            // Toggle icon between bars and times
            const icon = mobileMenuBtn.querySelector("i");
            if (icon) {
              if (isVisible) {
                icon.classList.remove("fa-times");
                icon.classList.add("fa-bars");
              } else {
                icon.classList.remove("fa-bars");
                icon.classList.add("fa-times");
              }
            }

            console.log("Mobile menu new state:", mobileMenu.style.display); // Debug log
          });
        } else {
          console.error("Mobile menu elements not found:", {
            button: !!mobileMenuBtn,
            menu: !!mobileMenu,
          });
        }

        // Close mobile menu when clicking outside
        document.addEventListener("click", function (event) {
          if (mobileMenu && mobileMenu.style.display === "block") {
            if (
              !mobileMenuBtn.contains(event.target) &&
              !mobileMenu.contains(event.target)
            ) {
              mobileMenu.style.display = "none";
              mobileMenuBtn.setAttribute("aria-expanded", "false");
              // Reset icon to bars
              const icon = mobileMenuBtn.querySelector("i");
              if (icon) {
                icon.classList.remove("fa-times");
                icon.classList.add("fa-bars");
              }
            }
          }
        });

        // Auto-dismiss flash messages after 5 seconds
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach((alert) => {
          setTimeout(() => {
            alert.style.opacity = "0";
            alert.style.transition = "opacity 0.5s ease";
            setTimeout(() => alert.remove(), 500);
          }, 5000);
        });
      });

      /**
       * Global utility functions
       */

      // Show loading overlay
      function showLoading() {
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.classList.remove("hidden");
        }
      }

      // Hide loading overlay
      function hideLoading() {
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.classList.add("hidden");
        }
      }

      // Show toast notification (GitHub Style)
      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className =
          "transform transition-all duration-300 translate-x-full";

        let bgColor = "bg-green-600";
        let icon = "fa-check-circle";

        if (type === "error") {
          bgColor = "bg-red-600";
          icon = "fa-exclamation-circle";
        } else if (type === "info") {
          bgColor = "bg-blue-600";
          icon = "fa-info-circle";
        } else if (type === "warning") {
          bgColor = "bg-yellow-500";
          icon = "fa-exclamation-triangle";
        }

        toast.innerHTML = `
          <div class="${bgColor} text-white px-4 py-3 rounded-md shadow-lg flex items-center space-x-3 border border-transparent">
            <i class="fas ${icon}"></i>
            <span class="font-medium text-sm">${escapeHtml(message)}</span>
          </div>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => {
          toast.classList.remove("translate-x-full");
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Dropdown hover functionality with delay to prevent flickering
      document.addEventListener("DOMContentLoaded", function () {
        const userDropdown = document.getElementById("userDropdown");
        const userMenuDropdown = document.getElementById("userMenuDropdown");
        let hideTimeout;

        if (userDropdown && userMenuDropdown) {
          // Show dropdown on hover
          userDropdown.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
            userMenuDropdown.classList.add("show");
          });

          // Delay hiding to allow mouse to move to dropdown
          userDropdown.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(function () {
              userMenuDropdown.classList.remove("show");
            }, 200); // 200ms delay
          });

          // Keep dropdown open when hovering over it
          userMenuDropdown.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
            userMenuDropdown.classList.add("show");
          });

          // Hide when leaving dropdown
          userMenuDropdown.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(function () {
              userMenuDropdown.classList.remove("show");
            }, 200);
          });
        }
      });

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("{{ url_for('static', filename='js/sw.js') }}")
            .then(
              function (registration) {
                console.log("ServiceWorker registration successful");
              },
              function (error) {
                console.log("ServiceWorker registration failed: ", error);
              }
            );
        });
      }
    </script>

    <!-- Push Notifications Script -->
    {% if user_id %}
    <script src="{{ url_for('static', filename='js/push-notifications.js') }}"></script>
    {% endif %} {% block extra_js %}{% endblock %}
  </body>
</html>
