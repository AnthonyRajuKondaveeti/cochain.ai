{% extends "base.html" %} {% block title %}My Bookmarks - CoChain.ai{% endblock
%} {% block content %}
<div class="container mx-auto px-4 py-8 bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8 border-b border-gray-200 pb-6">
      <h1 class="text-3xl font-light text-gray-900 mb-2 flex items-center">
        <i class="far fa-bookmark text-gray-500 mr-3"></i>
        My Bookmarks
      </h1>
      <p class="text-gray-600">Repositories you have saved for later.</p>
    </div>

  <!-- Filters & Controls -->
  <div class="bg-white rounded-md shadow-sm border border-gray-200 p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
    <div class="flex items-center space-x-2 text-gray-700 text-sm font-semibold">
      <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs border border-gray-200">
        {{ bookmarks|length }}
      </span>
      <span>Saved repositories</span>
    </div>
    
    <div class="flex items-center gap-2">
        <label for="sort-select" class="text-sm text-gray-500">Sort by:</label>
        <select
          id="sort-select"
          onchange="sortBookmarks(this.value)"
          class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 pl-3 pr-8 bg-white"
        >
          <option value="recent">Most Recent</option>
          <option value="oldest">Oldest First</option>
          <option value="title">Title (A-Z)</option>
          <option value="stars">Most Stars</option>
        </select>
    </div>
  </div>

  <!-- Bookmarks Grid -->
  {% if bookmarks and bookmarks|length > 0 %}
  <div id="bookmarks-grid" class="grid md:grid-cols-2 gap-6">
    {% for bookmark in bookmarks %}
    <div
      class="bookmark-card bg-white rounded-md shadow-sm border border-gray-200 hover:border-gray-300 transition-all duration-200 flex flex-col"
      data-created="{{ bookmark.created_at }}"
      data-title="{{ bookmark.title }}"
      data-stars="{{ bookmark.original_stars or 0 }}"
    >
      <!-- Card Header -->
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 rounded-t-md flex justify-between items-center">
        <div class="flex items-center text-sm text-gray-600">
            <i class="far fa-star mr-1.5"></i>
            <span class="font-semibold">{{ bookmark.original_stars or 0 }}</span>
            <span class="ml-1 text-xs text-gray-500">stars</span>
        </div>
        <span class="text-xs text-gray-400 font-mono">
            Added {{ bookmark.created_at|default('recently') }}
        </span>
      </div>

      <!-- Content -->
      <div class="p-5 flex-grow">
        <h3 class="text-lg font-bold text-blue-600 mb-2 break-all hover:underline">
            <a href="{{ bookmark.repository_url }}" target="_blank">{{ bookmark.title }}</a>
        </h3>

        <p class="text-gray-600 text-sm mb-4 leading-relaxed">
          {{ bookmark.description[:150] }}{% if bookmark.description|length >
          150 %}...{% endif %}
        </p>

        <!-- Metadata Badges -->
        <div class="flex flex-wrap gap-2 mb-4">
          {% if bookmark.complexity_level %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
            {{ bookmark.complexity_level }}
          </span>
          {% endif %} 
          {% if bookmark.domain %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
            {{ bookmark.domain }}
          </span>
          {% endif %}
        </div>

        <!-- Notes Section -->
        {% if bookmark.notes %}
        <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4 text-sm text-gray-800 relative group">
          <div class="font-semibold text-xs text-yellow-700 mb-1 flex items-center">
             <i class="far fa-sticky-note mr-1"></i> Note:
          </div>
          {{ bookmark.notes }}
        </div>
        {% endif %}
      </div>

      <!-- Actions Footer -->
      <div class="px-5 py-3 bg-gray-50 border-t border-gray-200 rounded-b-md flex gap-3">
        <a
            href="{{ bookmark.repository_url }}"
            target="_blank"
            class="flex-1 bg-white text-gray-700 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-100 transition text-center shadow-sm"
        >
            View Repo
        </a>

        <button
            onclick="editNotes('{{ bookmark.id }}', '{{ bookmark.notes or '' }}')"
            class="flex-1 bg-white text-gray-700 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-100 transition shadow-sm"
            title="Edit notes"
        >
            <i class="fas fa-pencil-alt mr-1 text-gray-500"></i> Notes
        </button>

        <button
            onclick="removeBookmark('{{ bookmark.id }}', this)"
            class="bg-white text-red-600 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-50 hover:border-red-200 transition shadow-sm"
            title="Remove bookmark"
        >
            <i class="far fa-trash-alt"></i>
        </button>
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- Empty State -->
  <div class="border border-dashed border-gray-300 rounded-md p-12 text-center bg-white">
    <i class="far fa-bookmark text-4xl text-gray-300 mb-4"></i>
    <h2 class="text-xl font-semibold text-gray-900 mb-2">No bookmarks yet</h2>
    <p class="text-gray-500 mb-6">
      Explore projects and save them here to track your progress.
    </p>
    <a
      href="{{ url_for('explore') }}"
      class="inline-block bg-green-600 text-white px-5 py-2 rounded-md font-semibold text-sm hover:bg-green-700 transition shadow-sm border border-green-700"
    >
      Explore Projects
    </a>
  </div>
  {% endif %}
  </div>
</div>

<!-- Edit Notes Modal -->
<div
  id="notes-modal"
  class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
>
  <div class="bg-white rounded-md shadow-xl border border-gray-200 max-w-md w-full p-0 overflow-hidden">
    <!-- Modal Header -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-sm font-bold text-gray-900">Edit Notes</h3>
      <button
        onclick="closeNotesModal()"
        class="text-gray-500 hover:text-blue-600"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-4">
        <label for="notes-input" class="block text-xs font-semibold text-gray-700 mb-2">
            Personal Note
        </label>
        <textarea
        id="notes-input"
        rows="4"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50"
        placeholder="Add your notes about this project..."
        ></textarea>
    </div>

    <!-- Modal Footer -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
      <button
        onclick="closeNotesModal()"
        class="bg-white text-gray-700 border border-gray-300 px-4 py-1.5 rounded-md text-sm font-medium hover:bg-gray-100 transition shadow-sm"
      >
        Cancel
      </button>
      <button
        onclick="saveNotes()"
        class="bg-green-600 text-white border border-green-700 px-4 py-1.5 rounded-md text-sm font-bold hover:bg-green-700 transition shadow-sm"
      >
        Save Note
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentProjectId = null;

  // Filter bookmarks
  function filterBookmarks(filter) {
    const cards = document.querySelectorAll(".bookmark-card");
    const buttons = document.querySelectorAll(".filter-btn");

    // Update active button
    buttons.forEach((btn) =>
      btn.classList.remove("active", "bg-blue-600", "text-white")
    );
    // Logic needs adjustment for new classes if filters strictly needed, 
    // but simplified UI removes filter buttons in favor of sort.
  }

  // Sort bookmarks
  function sortBookmarks(sortBy) {
    const grid = document.getElementById("bookmarks-grid");
    const cards = Array.from(document.querySelectorAll(".bookmark-card"));

    cards.sort((a, b) => {
      switch (sortBy) {
        case "recent":
          return new Date(b.dataset.created) - new Date(a.dataset.created);
        case "oldest":
          return new Date(a.dataset.created) - new Date(b.dataset.created);
        case "title":
          return a.dataset.title.localeCompare(b.dataset.title);
        case "stars":
          return parseInt(b.dataset.stars) - parseInt(a.dataset.stars);
        default:
          return 0;
      }
    });

    cards.forEach((card) => grid.appendChild(card));
  }

  // Edit notes
  function editNotes(projectId, currentNotes) {
    currentProjectId = projectId;
    document.getElementById("notes-input").value = currentNotes;
    document.getElementById("notes-modal").classList.remove("hidden");
  }

  function closeNotesModal() {
    document.getElementById("notes-modal").classList.add("hidden");
    currentProjectId = null;
  }

  function saveNotes() {
    const notes = document.getElementById("notes-input").value;

    // Update bookmark notes using dedicated endpoint
    fetch("/api/bookmark/notes", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        github_reference_id: currentProjectId,
        notes: notes,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showToast("Notes saved!", "success");
          closeNotesModal();
          location.reload(); // Refresh to show updated notes
        } else {
          showToast(data.error || "Failed to save notes", "error");
        }
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });
  }

  // Remove bookmark
  function removeBookmark(projectId, button) {
    if (!confirm("Are you sure you want to remove this bookmark?")) {
      return;
    }

    fetch(`/api/bookmark/${projectId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const card = button.closest(".bookmark-card");
          showToast("Bookmark removed", "success");
          card.style.opacity = "0";
          setTimeout(() => card.remove(), 300);
        } else {
          showToast(data.error || "Failed to remove bookmark", "error");
        }
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });
  }
</script>
{% endblock %}