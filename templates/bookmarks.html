{% extends "base.html" %} 

{% block title %}My Bookmarks - CoChain.ai{% endblock %} 

{% block content %}
<!-- Custom CSS for Shooting Stars & Animations -->
<style>
  /* Night Sky Background */
  .night-sky-bg {
    background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
  }

  /* Star styling */
  .star {
    position: absolute;
    top: 50%;
    left: 50%;
    height: 2px;
    background: linear-gradient(-45deg, #5f91ff, rgba(0, 0, 255, 0));
    filter: drop-shadow(0 0 6px #699bff);
    animation: tail 3000ms ease-in-out infinite, shooting 3000ms ease-in-out infinite;
    opacity: 0;
    z-index: -1;
  }

  /* The glowing head of the star */
  .star::before {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* The trail of the star */
  .star::after {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* Animations */
  @keyframes tail {
    0% { width: 0; }
    30% { width: 100px; }
    100% { width: 0; }
  }

  @keyframes shooting {
    0% { transform: translateX(0); }
    100% { transform: translateX(300px); }
  }

  @keyframes shining {
    0% { width: 0; }
    50% { width: 30px; }
    100% { width: 0; }
  }
  
  /* Twinkling static stars */
  .static-star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--duration) ease-in-out infinite;
    opacity: var(--opacity);
  }
  
  @keyframes twinkle {
    0%, 100% { opacity: var(--opacity); transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
  }
</style>

<!-- BACKGROUND CONTAINER (Fixed position, behind everything) -->
<div class="fixed inset-0 night-sky-bg overflow-hidden pointer-events-none" style="z-index: -1;">
  <div id="star-container"></div>
  <div id="static-star-container"></div>
</div>

<!-- CONTENT WRAPPER -->
<div class="min-h-screen relative z-10">
    
    <!-- Sticky Header with Glassmorphism -->
    <div class="bg-white/95 backdrop-blur-sm shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Title & Count -->
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="far fa-bookmark text-blue-600 mr-3"></i>
                        My Bookmarks
                    </h1>
                    <span class="ml-4 bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold border border-gray-200">
                        {{ bookmarks|length }} Saved
                    </span>
                </div>

                <!-- Sort Control -->
                <div class="flex items-center gap-2">
                    <label for="sort-select" class="text-xs font-semibold text-gray-500 uppercase">Sort by:</label>
                    <select
                      id="sort-select"
                      onchange="sortBookmarks(this.value)"
                      class="text-sm border-gray-300 text-gray-700 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 pl-3 pr-8 bg-white cursor-pointer hover:border-blue-400 transition"
                    >
                      <option value="recent">Most Recent</option>
                      <option value="oldest">Oldest First</option>
                      <option value="title">Title (A-Z)</option>
                      <option value="stars">Most Stars</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-6 py-8">
      
      <!-- Bookmarks Grid -->
      {% if bookmarks and bookmarks|length > 0 %}
      <div id="bookmarks-grid" class="grid md:grid-cols-2 gap-6">
        {% for bookmark in bookmarks %}
        <div
          class="bookmark-card bg-white/95 backdrop-blur-sm rounded-md shadow-md border border-gray-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col"
          data-created="{{ bookmark.created_at }}"
          data-title="{{ bookmark.title }}"
          data-stars="{{ bookmark.original_stars or 0 }}"
        >
          <!-- Card Header -->
          <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-200 rounded-t-md flex justify-between items-center">
            <div class="flex items-center text-sm text-gray-600">
                <i class="far fa-star mr-1.5 text-yellow-500"></i>
                <span class="font-semibold text-gray-800">{{ bookmark.original_stars or 0 }}</span>
                <span class="ml-1 text-xs text-gray-500">stars</span>
            </div>
            <span class="text-xs text-gray-400 font-mono flex items-center">
                <i class="far fa-clock mr-1"></i> {{ bookmark.created_at|default('recently') }}
            </span>
          </div>
    
          <!-- Content -->
          <div class="p-5 flex-grow">
            <h3 class="text-lg font-bold text-blue-600 mb-2 break-all hover:underline leading-tight">
                <a href="{{ bookmark.repository_url }}" target="_blank">{{ bookmark.title }}</a>
            </h3>
    
            <p class="text-gray-600 text-sm mb-4 leading-relaxed line-clamp-3">
              {{ bookmark.description[:150] }}{% if bookmark.description|length > 150 %}...{% endif %}
            </p>
    
            <!-- Metadata Badges -->
            <div class="flex flex-wrap gap-2 mb-4">
              {% if bookmark.complexity_level %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                {{ bookmark.complexity_level }}
              </span>
              {% endif %} 
              {% if bookmark.domain %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                {{ bookmark.domain }}
              </span>
              {% endif %}
            </div>
    
            <!-- Notes Section -->
            {% if bookmark.notes %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4 text-sm text-gray-800 relative group shadow-sm">
              <div class="font-bold text-xs text-yellow-700 mb-1 flex items-center uppercase tracking-wide">
                 <i class="far fa-sticky-note mr-1.5"></i> My Note
              </div>
              <p class="italic text-gray-700">{{ bookmark.notes }}</p>
            </div>
            {% endif %}
          </div>
    
          <!-- Actions Footer -->
          <div class="px-5 py-3 bg-gray-50/80 border-t border-gray-200 rounded-b-md flex gap-3">
            <a
                href="{{ bookmark.repository_url }}"
                target="_blank"
                class="flex-1 bg-white text-gray-700 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-50 transition text-center shadow-sm"
            >
                View Repo
            </a>
    
            <button
                onclick="editNotes('{{ bookmark.id }}', '{{ bookmark.notes or '' }}')"
                class="flex-1 bg-white text-gray-700 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-50 transition shadow-sm"
                title="Edit notes"
            >
                <i class="fas fa-pencil-alt mr-1 text-gray-500"></i> Notes
            </button>
    
            <button
                onclick="removeBookmark('{{ bookmark.id }}', this)"
                class="bg-white text-red-600 border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-50 hover:border-red-200 transition shadow-sm"
                title="Remove bookmark"
            >
                <i class="far fa-trash-alt"></i>
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    
      {% else %}
      <!-- Empty State -->
      <div class="bg-white/95 backdrop-blur-sm border border-dashed border-gray-300 rounded-md p-12 text-center shadow-lg">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="far fa-bookmark text-gray-400 text-3xl"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-900 mb-2">No bookmarks yet</h2>
        <p class="text-gray-500 mb-6 max-w-md mx-auto">
          You haven't saved any repositories yet. Explore projects and save them here to track your progress.
        </p>
        <a
          href="{{ url_for('explore') }}"
          class="inline-block bg-blue-600 text-white px-6 py-2 rounded-md font-semibold text-sm hover:bg-blue-700 transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
        >
          Explore Projects
        </a>
      </div>
      {% endif %}
      </div>
</div>

<!-- Edit Notes Modal -->
<div
  id="notes-modal"
  class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
>
  <div class="bg-white rounded-lg shadow-2xl border border-gray-200 max-w-md w-full p-0 overflow-hidden transform transition-all scale-100">
    <!-- Modal Header -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide">Edit Personal Note</h3>
      <button
        onclick="closeNotesModal()"
        class="text-gray-400 hover:text-gray-600 transition"
      >
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
        <label for="notes-input" class="block text-xs font-bold text-gray-700 mb-2 uppercase">
            Your Note
        </label>
        <textarea
        id="notes-input"
        rows="4"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50 text-gray-900"
        placeholder="Add your thoughts, ideas, or reminders about this project..."
        ></textarea>
    </div>

    <!-- Modal Footer -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex justify-end gap-3">
      <button
        onclick="closeNotesModal()"
        class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-50 transition shadow-sm"
      >
        Cancel
      </button>
      <button
        onclick="saveNotes()"
        class="bg-blue-600 text-white border border-blue-700 px-4 py-2 rounded-md text-sm font-bold hover:bg-blue-700 transition shadow-sm"
      >
        Save Note
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

{% endblock %} 

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      createShootingStars(); 
  });

  /**
   * Create Shooting Stars Background Effect
   */
  function createShootingStars() {
      const starContainer = document.getElementById('star-container');
      const staticContainer = document.getElementById('static-star-container');
      const starCount = 15; // Number of shooting stars
      const staticCount = 50; // Number of background twinkling stars
      
      // 1. Create Shooting Stars
      for (let i = 0; i < starCount; i++) {
          const star = document.createElement('span');
          star.className = 'star';
          
          const top = Math.random() * 100;
          const left = Math.random() * 100;
          const delay = Math.random() * 5000;
          const duration = 3000 + Math.random() * 3000;
          
          star.style.top = top + '%';
          star.style.left = left + '%';
          star.style.width = (Math.random() * 100 + 100) + 'px';
          star.style.animationDelay = delay + 'ms';
          star.style.animationDuration = duration + 'ms';
          star.style.transform = 'rotateZ(45deg)';
          
          starContainer.appendChild(star);
      }

      // 2. Create Static Twinkling Stars
      for (let i = 0; i < staticCount; i++) {
          const dot = document.createElement('div');
          dot.className = 'static-star';
          const size = Math.random() * 2 + 1; 
          
          dot.style.width = size + 'px';
          dot.style.height = size + 'px';
          dot.style.top = Math.random() * 100 + '%';
          dot.style.left = Math.random() * 100 + '%';
          dot.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
          dot.style.setProperty('--opacity', Math.random() * 0.5 + 0.1);
          
          staticContainer.appendChild(dot);
      }
  }

  // --- EXISTING LOGIC ---
  let currentProjectId = null;

  // Sort bookmarks
  function sortBookmarks(sortBy) {
    const grid = document.getElementById("bookmarks-grid");
    const cards = Array.from(document.querySelectorAll(".bookmark-card"));

    cards.sort((a, b) => {
      switch (sortBy) {
        case "recent":
          return new Date(b.dataset.created) - new Date(a.dataset.created);
        case "oldest":
          return new Date(a.dataset.created) - new Date(b.dataset.created);
        case "title":
          return a.dataset.title.localeCompare(b.dataset.title);
        case "stars":
          return parseInt(b.dataset.stars) - parseInt(a.dataset.stars);
        default:
          return 0;
      }
    });

    cards.forEach((card) => grid.appendChild(card));
  }

  // Edit notes
  function editNotes(projectId, currentNotes) {
    currentProjectId = projectId;
    document.getElementById("notes-input").value = currentNotes;
    document.getElementById("notes-modal").classList.remove("hidden");
  }

  function closeNotesModal() {
    document.getElementById("notes-modal").classList.add("hidden");
    currentProjectId = null;
  }

  function saveNotes() {
    const notes = document.getElementById("notes-input").value;

    fetch("/api/bookmark/notes", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        github_reference_id: currentProjectId,
        notes: notes,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showToast("Notes saved!", "success");
          closeNotesModal();
          location.reload(); 
        } else {
          showToast(data.error || "Failed to save notes", "error");
        }
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });
  }

  // Remove bookmark
  function removeBookmark(projectId, button) {
    if (!confirm("Are you sure you want to remove this bookmark?")) {
      return;
    }

    fetch(`/api/bookmark/${projectId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const card = button.closest(".bookmark-card");
          showToast("Bookmark removed", "success");
          // Animate removal
          card.style.transform = "scale(0.9)";
          card.style.opacity = "0";
          setTimeout(() => {
              card.remove();
              // Update count check if needed, or simple reload
              const remaining = document.querySelectorAll('.bookmark-card').length;
              if(remaining === 0) location.reload();
          }, 300);
        } else {
          showToast(data.error || "Failed to remove bookmark", "error");
        }
      })
      .catch((error) => {
        showToast("Error: " + error.message, "error");
      });
  }

  // Toast Functionality (reused from other pages)
  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'transform transition-all duration-300 translate-x-full mb-4';
      let bgColor = 'bg-green-600'; 
      let icon = 'fa-check-circle';

      if (type === 'error') {
          bgColor = 'bg-red-600'; icon = 'fa-exclamation-circle';
      } else if (type === 'info') {
          bgColor = 'bg-blue-600'; icon = 'fa-info-circle';
      }

      toast.innerHTML = `
          <div class="${bgColor} text-white px-6 py-3 rounded-md shadow-lg flex items-center space-x-3 border border-transparent">
              <i class="fas ${icon}"></i>
              <span class="font-medium text-sm">${escapeHtml(message)}</span>
          </div>
      `;
      container.appendChild(toast);
      setTimeout(() => { toast.classList.remove('translate-x-full'); }, 10);
      setTimeout(() => {
          toast.classList.add('translate-x-full');
          setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
  }
  
  function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
  }
</script>
{% endblock %}