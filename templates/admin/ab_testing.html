{% extends "base.html" %}

{% block title %}A/B Testing Dashboard - CoChain.ai{% endblock %}

{% block extra_css %}
<!-- Bootstrap CSS (Grid & Modals) -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<style>
  /* GitHub Primer Theme Variables */
  :root {
    --gh-bg: #f6f8fa;
    --gh-text-main: #24292f;
    --gh-text-muted: #57606a;
    --gh-border: #d0d7de;
    --gh-blue: #0969da;
    --gh-green: #2da44e;
    --gh-red: #cf222e;
    --gh-purple: #8250df;
    --gh-card-bg: #ffffff;
  }

  .ab-dashboard {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .dashboard-header {
    background: var(--gh-card-bg);
    border: 1px solid var(--gh-border);
    border-radius: 6px;
    padding: 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .test-card {
    background: var(--gh-card-bg);
    border: 1px solid var(--gh-border);
    border-radius: 6px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
  }

  /* Metric Grid */
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .metric-card {
    background: #f6f8fa;
    border: 1px solid var(--gh-border);
    padding: 16px;
    border-radius: 6px;
    text-align: center;
  }
  
  /* Subtle coloring for groups */
  .metric-card.control { border-left: 4px solid #cf222e; } /* Red/Pink baseline */
  .metric-card.treatment { border-left: 4px solid #0969da; } /* Blue treatment */

  .metric-value {
    font-size: 24px;
    font-weight: 600;
    margin: 8px 0;
    color: var(--gh-text-main);
  }

  .metric-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gh-text-muted);
    text-transform: uppercase;
  }

  /* Badges */
  .status-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 2em;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid transparent;
  }
  .status-active { background: #dafbe1; color: #1a7f37; border-color: rgba(26,127,55,0.2); }
  .status-ended { background: #f6f8fa; color: #57606a; border-color: #d0d7de; }
  .status-paused { background: #fff8c5; color: #9a6700; border-color: rgba(154,103,0,0.2); }

  .winner-badge {
    background: #ddf4ff;
    color: #0969da;
    border: 1px solid rgba(84,174,255,0.4);
    padding: 2px 10px;
    border-radius: 2em;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
  }

  /* Buttons */
  .btn-gh-primary {
    background-color: var(--gh-green);
    color: white;
    border: 1px solid rgba(27,31,36,0.15);
    font-weight: 600;
    border-radius: 6px;
    padding: 6px 16px;
    font-size: 14px;
  }
  .btn-gh-primary:hover { background-color: #2c974b; color: white; }

  .btn-gh-outline {
    background-color: #f6f8fa;
    color: #24292f;
    border: 1px solid rgba(27,31,36,0.15);
    font-weight: 500;
    border-radius: 6px;
    padding: 6px 16px;
    font-size: 14px;
  }
  .btn-gh-outline:hover { background-color: #f3f4f6; border-color: rgba(27,31,36,0.15); }

  .btn-gh-danger {
    color: #cf222e;
    background-color: #f6f8fa;
    border: 1px solid rgba(27,31,36,0.15);
    font-weight: 500;
    border-radius: 6px;
    padding: 6px 16px;
    font-size: 14px;
  }
  .btn-gh-danger:hover {
    background-color: #ffebe9;
    color: #cf222e;
    border-color: rgba(27,31,36,0.15);
  }

  /* Significance Indicator */
  .significance-indicator {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 600;
    margin: 16px 0;
    border: 1px solid transparent;
    font-size: 14px;
  }
  .significance-yes { background: #dafbe1; color: #1a7f37; border-color: rgba(45,164,78,0.4); }
  .significance-no { background: #f6f8fa; color: #57606a; border-color: #d0d7de; }

  .comparison-vs {
    font-size: 24px;
    font-weight: 700;
    color: var(--gh-text-muted);
    text-align: center;
    padding: 20px 0;
    opacity: 0.5;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    border: 1px dashed var(--gh-border);
    border-radius: 6px;
    background: #f6f8fa;
  }
  .empty-state i { font-size: 48px; color: #d0d7de; margin-bottom: 16px; }

  /* Past Tests List */
  .past-test-item {
    border: 1px solid var(--gh-border);
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 8px;
    background: white;
  }
</style>
{% endblock %}

{% block content %}
    <div class="ab-dashboard">
      <!-- Header Area -->
      <div class="dashboard-header">
        <div>
            <h1 class="h4 font-bold text-gray-900 mb-1">
                <i class="fas fa-flask mr-2 text-gray-500"></i> A/B Testing Dashboard
            </h1>
            <p class="text-sm text-gray-500 mb-0">
              Compare RL (Reinforcement Learning) vs Baseline algorithms.
            </p>
        </div>
        <div class="flex gap-2">
            <a href="/admin/analytics" class="btn-gh-outline">
              <i class="fas fa-arrow-left mr-1"></i> Back
            </a>
            <a href="/admin/rl-performance" class="btn-gh-outline">
              <i class="fas fa-chart-line mr-1"></i> RL Stats
            </a>
            <button class="btn-gh-primary" onclick="openNewTestModal()">
              <i class="fas fa-plus mr-1"></i> New Test
            </button>
        </div>
      </div>

      <!-- Active Test Section -->
      <div id="activeTestSection"></div>

      <!-- Past Tests Section -->
      <div class="test-card">
        <h3 class="h6 font-bold text-gray-900 mb-3 border-b border-gray-200 pb-2">
            <i class="fas fa-history text-gray-400 mr-2"></i> Past Tests
        </h3>
        <div id="pastTestsSection"></div>
      </div>
    </div>

    <!-- New Test Modal -->
    <div class="modal fade" id="newTestModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header border-bottom-0 pb-0">
            <h5 class="modal-title font-bold text-gray-900">Start New A/B Test</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="newTestForm">
              <div class="mb-3">
                <label class="form-label text-sm font-bold text-gray-700">Test Name</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="testName"
                  required
                  placeholder="e.g., RL vs Baseline Q4 2025"
                />
              </div>
              <div class="mb-3">
                <label class="form-label text-sm font-bold text-gray-700">Description</label>
                <textarea
                  class="form-control form-control-sm"
                  id="testDescription"
                  rows="3"
                  placeholder="Optional: Describe what you're testing"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label text-sm font-bold text-gray-700">Control Group % (Baseline)</label>
                <input
                  type="number"
                  class="form-control form-control-sm"
                  id="controlPercentage"
                  value="50"
                  min="10"
                  max="90"
                  required
                />
                <small class="text-muted"
                  >Remaining % will use RL (Treatment)</small
                >
              </div>
              <div class="mb-3">
                <label class="form-label text-sm font-bold text-gray-700">Duration (days)</label>
                <input
                  type="number"
                  class="form-control form-control-sm"
                  id="durationDays"
                  value="14"
                  min="7"
                  max="90"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer border-top-0 pt-0">
            <button
              type="button"
              class="btn-gh-outline"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn-gh-primary"
              onclick="startNewTest()"
            >
              Start Test
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      style="
        display: none;
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(2px);
        z-index: 9999;
        align-items: center; justify-content: center;
      "
    >
      <div class="text-center p-4 bg-white border border-gray-200 shadow-lg rounded-md">
         <div class="spinner-border text-primary mb-2" role="status"></div>
         <div class="font-bold text-gray-800">Processing...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let currentTest = null;
      let metricsChart = null;

      // Load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadABTestData();
        setInterval(loadABTestData, 30000); // Refresh every 30 seconds
      });

      async function loadABTestData() {
        try {
          const response = await fetch("/api/admin/ab-testing/dashboard");
          const data = await response.json();

          if (data.success) {
            renderActiveTest(data.active_test, data.metrics);
            renderPastTests(data.past_tests);
          }
        } catch (error) {
          console.error("Error loading A/B test data:", error);
        }
      }

      function renderActiveTest(test, metrics) {
        const section = document.getElementById("activeTestSection");

        if (!test) {
          section.innerHTML = `
                <div class="test-card">
                    <div class="empty-state">
                        <i class="fas fa-flask"></i>
                        <h4 class="h5 font-bold text-gray-900">No Active A/B Test</h4>
                        <p class="text-muted text-sm mb-4">Start comparing RL vs Baseline to find the best recommendation system</p>
                        <button class="btn-gh-primary" onclick="openNewTestModal()">
                            Start Your First Test
                        </button>
                    </div>
                </div>
            `;
          return;
        }

        currentTest = test;

        const winner = metrics?.winner;
        const significance = metrics?.significance;

        section.innerHTML = `
            <div class="test-card border-l-4 border-l-green-500">
                <div class="d-flex justify-content-between align-items-start mb-4 border-bottom border-gray-100 pb-3">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <h3 class="h5 font-bold text-gray-900 mb-0">
                                ${test.test_name}
                            </h3>
                            <span class="status-badge status-${test.status}">${test.status.toUpperCase()}</span>
                            ${
                              winner
                                ? `<span class="winner-badge"><i class="fas fa-trophy"></i> Winner: ${winner.toUpperCase()}</span>`
                                : ""
                            }
                        </div>
                        <p class="text-muted text-sm mb-1">${
                          test.description ||
                          "Testing RL recommendations vs baseline"
                        }</p>
                        <div class="text-xs text-gray-500 font-mono mt-2">
                             Started: ${new Date(test.start_date).toLocaleDateString()} &middot;
                             Ends: ${new Date(test.end_date).toLocaleDateString()}
                        </div>
                    </div>
                    <div>
                        <button class="btn-gh-danger" onclick="endTest('${test.id}')">
                            End Test
                        </button>
                    </div>
                </div>

                ${renderMetricsComparison(metrics)}
            </div>
        `;
      }

      function renderMetricsComparison(metrics) {
        if (!metrics || !metrics.control || !metrics.treatment) {
          return `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2 text-sm">Collecting data...</p>
                </div>
            `;
        }

        const control = metrics.control;
        const treatment = metrics.treatment;
        const sig = metrics.significance;

        const ctrDiff = (((treatment.ctr - control.ctr) / control.ctr) * 100).toFixed(1);

        return `
            <div class="row mb-4">
                <!-- Control Group -->
                <div class="col-md-5">
                    <h5 class="text-center mb-3 text-sm font-bold text-gray-500 uppercase">
                         Control Group (Baseline)
                    </h5>
                    <div class="metric-grid">
                        <div class="metric-card control">
                            <div class="metric-label">Users</div>
                            <div class="metric-value">${control.user_count}</div>
                        </div>
                        <div class="metric-card control">
                            <div class="metric-label">CTR</div>
                            <div class="metric-value">${control.ctr}%</div>
                            <small class="text-muted text-xs">${control.clicks}/${control.impressions}</small>
                        </div>
                        <div class="metric-card control">
                            <div class="metric-label">Avg Reward</div>
                            <div class="metric-value text-gray-600 fs-5">${control.avg_reward}</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="comparison-vs">VS</div>
                </div>

                <!-- Treatment Group -->
                <div class="col-md-5">
                    <h5 class="text-center mb-3 text-sm font-bold text-blue-600 uppercase">
                         Treatment Group (RL)
                    </h5>
                    <div class="metric-grid">
                        <div class="metric-card treatment">
                            <div class="metric-label">Users</div>
                            <div class="metric-value">${treatment.user_count}</div>
                        </div>
                        <div class="metric-card treatment">
                            <div class="metric-label">CTR</div>
                            <div class="metric-value text-blue-600">${treatment.ctr}%</div>
                            <small class="text-muted text-xs">${treatment.clicks}/${treatment.impressions}</small>
                        </div>
                        <div class="metric-card treatment">
                            <div class="metric-label">Avg Reward</div>
                            <div class="metric-value text-gray-600 fs-5">${treatment.avg_reward}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                 <span class="px-3 py-1 rounded-md text-sm font-semibold border ${treatment.ctr > control.ctr ? 'bg-green-50 text-green-700 border-green-200' : 'bg-yellow-50 text-yellow-700 border-yellow-200'}">
                    Performance Difference: CTR ${ctrDiff > 0 ? "+" : ""}${ctrDiff}%
                </span>
            </div>

            ${
              sig
                ? `
                <div class="text-center mt-4">
                    <div class="significance-indicator ${sig.significant ? "significance-yes" : "significance-no"}">
                        <i class="fas ${sig.significant ? "fa-check-circle" : "fa-hourglass-half"}"></i>
                        <div>
                            <div>${sig.significant ? "Statistically Significant Result" : "Collecting More Data..."}</div>
                            ${sig.p_value ? `<div class="fw-normal text-xs opacity-75">p-value: ${sig.p_value}</div>` : ""}
                        </div>
                    </div>
                    ${
                      metrics.winner
                        ? `
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-100 rounded-md">
                            <h6 class="font-bold text-blue-800 mb-2">Recommendation Available</h6>
                            <button class="btn-gh-primary" onclick="rolloutWinner('${currentTest.id}')">
                                Rollout ${metrics.winner.toUpperCase()} to 100%
                            </button>
                        </div>
                    `
                        : ""
                    }
                </div>
            `
                : ""
            }
        `;
      }

      function renderPastTests(tests) {
        const section = document.getElementById("pastTestsSection");

        if (!tests || tests.length === 0) {
          section.innerHTML = '<p class="text-muted text-sm p-3">No past tests recorded.</p>';
          return;
        }

        section.innerHTML = tests
          .map(
            (test) => `
            <div class="past-test-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-gray-900">${test.test_name}</strong>
                        <span class="status-badge status-${test.status} ms-2">${test.status}</span>
                        ${
                          test.winner
                            ? `<span class="winner-badge">${test.winner}</span>`
                            : ""
                        }
                    </div>
                    <small class="text-muted font-mono text-xs">
                        ${new Date(test.start_date).toLocaleDateString()} - 
                        ${
                          test.ended_at
                            ? new Date(test.ended_at).toLocaleDateString()
                            : "Ongoing"
                        }
                    </small>
                </div>
            </div>
        `
          )
          .join("");
      }

      function showNewTestModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("newTestModal")
        );
        modal.show();
      }

      function openNewTestModal() {
        showNewTestModal();
      }

      async function startNewTest() {
        const testName = document.getElementById("testName").value;
        const description = document.getElementById("testDescription").value;
        const controlPercentage = parseInt(document.getElementById("controlPercentage").value);
        const durationDays = parseInt(document.getElementById("durationDays").value);

        if (!testName) {
          alert("Please enter a test name");
          return;
        }

        document.getElementById("loadingOverlay").style.display = "flex";

        try {
          const response = await fetch("/api/admin/ab-testing/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              test_name: testName,
              description: description,
              control_percentage: controlPercentage,
              duration_days: durationDays,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("âœ… A/B test started successfully!");
            const modal = bootstrap.Modal.getInstance(document.getElementById("newTestModal"));
            modal.hide();
            // Clear form
            document.getElementById("testName").value = "";
            document.getElementById("testDescription").value = "";
            loadABTestData();
          } else {
            alert("Failed to start test: " + result.error);
          }
        } catch (error) {
          alert("Error starting test: " + error.message);
        } finally {
          document.getElementById("loadingOverlay").style.display = "none";
        }
      }

      async function endTest(testId) {
        if (!confirm("Are you sure you want to end this test?")) return;

        document.getElementById("loadingOverlay").style.display = "flex";

        try {
          const response = await fetch(`/api/admin/ab-testing/end/${testId}`, {
            method: "POST",
          });

          const result = await response.json();

          if (result.success) {
            alert(`Test ended!\n\n${result.recommendation}`);
            loadABTestData();
          } else {
            alert("Failed to end test: " + result.message);
          }
        } catch (error) {
          alert("Error ending test: " + error.message);
        } finally {
          document.getElementById("loadingOverlay").style.display = "none";
        }
      }

      async function rolloutWinner(testId) {
        if (!confirm("This will end the test and rollout the winning variant to all users. Continue?")) return;
        await endTest(testId);
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}