{% extends "base.html" %}

{% block title %}RL Performance Dashboard - CoChain.ai Admin{% endblock %}

{% block extra_css %}
<!-- Bootstrap CSS (Grid System) -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
  /* GitHub Primer Variables */
  :root {
    --gh-bg: #f6f8fa;
    --gh-border: #d0d7de;
    --gh-text-main: #24292f;
    --gh-text-muted: #57606a;
    --gh-blue: #0969da;
    --gh-green: #2da44e;
    --gh-red: #cf222e;
    --gh-orange: #9a6700;
    --gh-card-bg: #ffffff;
  }

  /* Dashboard Cards */
  .stat-card, .chart-card {
    background: var(--gh-card-bg);
    border: 1px solid var(--gh-border);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 600;
    margin: 4px 0;
    color: var(--gh-text-main);
  }

  .stat-label {
    color: var(--gh-text-muted);
    font-size: 0.85rem;
    font-weight: 600;
  }

  .stat-change {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
    margin-top: 4px;
    border: 1px solid transparent;
  }

  .stat-change.positive { background: #dafbe1; color: #1a7f37; border-color: rgba(26,127,55,0.1); }
  .stat-change.negative { background: #ffebe9; color: #cf222e; border-color: rgba(207,34,46,0.1); }
  .stat-change.neutral { background: #f6f8fa; color: #57606a; border-color: #d0d7de; }

  .chart-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--gh-text-main);
    border-bottom: 1px solid var(--gh-border);
    padding-bottom: 12px;
  }

  /* Status Badges */
  .status-badge {
    padding: 4px 10px;
    border-radius: 2em;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    border: 1px solid transparent;
  }
  .status-enabled { background: #dafbe1; color: #1a7f37; border-color: rgba(26,127,55,0.2); }
  .status-disabled { background: #ffebe9; color: #cf222e; border-color: rgba(207,34,46,0.2); }

  /* Buttons */
  .btn-train {
    background-color: var(--gh-green);
    border: 1px solid rgba(27,31,36,0.15);
    color: white;
    font-weight: 600;
    padding: 6px 16px;
    border-radius: 6px;
    transition: 0.2s;
    font-size: 0.9rem;
  }
  .btn-train:hover {
    background-color: #2c974b;
    color: white;
  }

  /* Time Selector (Segmented Control) */
  .time-selector {
    display: inline-flex;
    background: #f6f8fa;
    border: 1px solid var(--gh-border);
    border-radius: 6px;
    padding: 2px;
  }
  .time-btn {
    padding: 4px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    color: var(--gh-text-main);
    border-radius: 4px;
  }
  .time-btn:hover { background: rgba(0,0,0,0.05); }
  .time-btn.active {
    background: white;
    color: var(--gh-blue);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-weight: 600;
  }

  /* Tables */
  .top-projects-table th {
    background: #f6f8fa;
    font-weight: 600;
    font-size: 0.75rem;
    color: var(--gh-text-muted);
    border-bottom: 1px solid var(--gh-border);
    text-transform: uppercase;
  }
  .top-projects-table td {
    vertical-align: middle;
    padding: 10px;
    font-size: 0.9rem;
    border-bottom: 1px solid #eaeef2;
  }

  /* Rank Badges */
  .rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-weight: 600;
    font-size: 0.75rem;
    border: 1px solid rgba(0,0,0,0.1);
  }
  .rank-1 { background: #fff8c5; color: #9a6700; }
  .rank-2 { background: #f6f8fa; color: #57606a; }
  .rank-3 { background: #f3f4f6; color: #57606a; }
  .rank-other { background: transparent; color: #57606a; border: none; }

  /* Config Cards */
  .config-card {
    background: #f6f8fa;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid var(--gh-border);
  }
  .config-label { font-size: 0.75rem; color: var(--gh-text-muted); }
  .config-value { font-size: 1.1rem; font-weight: 600; color: var(--gh-text-main); }

  /* Alerts */
  .alert-custom {
    background: #ddf4ff;
    border: 1px solid rgba(84,174,255,0.4);
    color: #0969da;
    border-radius: 6px;
    padding: 16px;
  }
  .alert-success { background: #dafbe1; border-color: rgba(74,194,107,0.4); color: #1a7f37; }
  .alert-warning { background: #fff8c5; border-color: rgba(212,167,44,0.4); color: #9a6700; }
  .alert-danger { background: #ffebe9; border-color: rgba(255,129,130,0.4); color: #cf222e; }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(2px);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
  }
  .loading-spinner {
    background: white; padding: 24px; border-radius: 6px;
    box-shadow: 0 8px 24px rgba(140,149,159,0.2);
    border: 1px solid var(--gh-border);
    text-align: center;
  }
</style>
{% endblock %}

{% block content %}
    <!-- Main Content -->
    <div class="container-fluid mt-4 px-4 px-md-5">
      <!-- Page Header -->
      <div class="row mb-4 align-items-center">
        <div class="col-md-6">
          <h1 class="h3 font-bold text-gray-900">
            RL Performance Dashboard
          </h1>
          <p class="text-gray-500 text-sm mb-0">Monitor model rewards and training metrics</p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
             <div class="time-selector">
                <button class="time-btn" onclick="changePeriod(1, event)">24h</button>
                <button class="time-btn active" onclick="changePeriod(7, event)">7 days</button>
                <button class="time-btn" onclick="changePeriod(30, event)">30 days</button>
                <button class="time-btn" onclick="changePeriod(90, event)">90 days</button>
            </div>
        </div>
      </div>

      <!-- Status Banner -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="alert alert-custom" id="statusAlert" role="alert">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <strong>Loading RL performance data...</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-graph-up me-1"></i> Average Reward
            </div>
            <div class="stat-value" id="avgReward">--</div>
            <span class="stat-change" id="rewardChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-hand-thumbs-up me-1"></i> Positive Rate
            </div>
            <div class="stat-value" id="positiveRate">--</div>
            <span class="stat-change" id="positiveChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-collection me-1"></i> Training Examples
            </div>
            <div class="stat-value" id="trainingExamples">--</div>
            <span class="stat-change" id="examplesChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-lightning-charge me-1"></i> Exploration Rate
            </div>
            <div class="stat-value" id="explorationRate">--</div>
            <span class="stat-change neutral">Current</span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <!-- Reward Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              Reward Trend Over Time
            </h5>
            <canvas id="rewardTrendChart"></canvas>
          </div>
        </div>

        <!-- CTR Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              CTR Improvement
            </h5>
            <canvas id="ctrTrendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- How RL Training Works Explanation -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="alert alert-info border-0 bg-blue-50">
            <h6 class="mb-2 text-blue-900">
              <i class="bi bi-info-circle-fill me-2"></i>How RL Training Works
            </h6>
            <p class="mb-2 text-sm text-blue-800">
              <strong>Training Process:</strong> Each training session updates the model using recent user interactions (clicks, bookmarks, views). 
              The model learns which projects users engage with most.
            </p>
            <p class="mb-0 text-sm text-blue-800">
              <strong>Viewing Improvement:</strong> Charts show progression across multiple training sessions. 
              Improvement happens gradually as the model learns from more user feedback over time. 
              Run training regularly to keep recommendations fresh!
            </p>
          </div>
        </div>
      </div>

      <!-- Top Projects & Configuration -->
      <div class="row mb-4">
        <!-- Top Performing Projects -->
        <div class="col-md-8">
          <div class="chart-card">
            <h5 class="chart-title">
              Best Performing Recommendations
            </h5>
            <p class="text-muted" style="font-size: 0.85rem; margin-top: -8px; margin-bottom: 12px;">
              Projects ranked by RL effectiveness (Click-through rate & interaction volume)
            </p>
            <div class="table-responsive">
              <table class="table top-projects-table" id="topProjectsTable">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Project</th>
                    <th>Success Rate</th>
                    <th>Interactions</th>
                    <th>Avg Reward</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- System Configuration -->
        <div class="col-md-4">
          <div class="chart-card">
            <h5 class="chart-title">
              System Configuration
            </h5>

            <div class="config-card">
              <div class="config-label">RL Status</div>
              <div class="mt-1">
                <span class="status-badge" id="rlStatus">
                  <i class="bi bi-circle-fill me-1"></i>Loading...
                </span>
              </div>
            </div>

            <div class="config-card">
              <div class="config-label">Similarity Weight</div>
              <div class="config-value" id="similarityWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Bandit Weight</div>
              <div class="config-value" id="banditWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Last Training</div>
              <div
                class="config-value"
                id="lastTraining"
                style="font-size: 1rem"
              >
                --
              </div>
            </div>

            <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded text-xs text-blue-700">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Training Mode:</strong> Manual only (trigger from admin panel)
            </div>
          </div>
        </div>
      </div>

      <!-- Training History -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="chart-card">
            <h5 class="chart-title">
              Recent Training History
            </h5>
            <div class="table-responsive">
              <table class="table table-sm top-projects-table" id="trainingHistoryTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Avg Reward</th>
                    <th>Positive Rate</th>
                    <th>Examples</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center py-3">
                      <div
                        class="spinner-border spinner-border-sm text-primary"
                        role="status"
                      >
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Trigger Training Button -->
      <div class="row mt-4 mb-5">
        <div class="col-12 text-end">
          <button class="btn btn-train" onclick="triggerTraining()">
            <i class="bi bi-lightning-charge me-2"></i>Trigger Manual Training
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none">
      <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="font-bold text-gray-800">Processing</div>
        <div class="text-xs text-gray-500 mt-1">This may take a few moments</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      console.log("ðŸ”§ RL Dashboard: Script block started");
      let currentPeriod = 7;
      let rewardChart, ctrChart;
      console.log("ðŸ”§ RL Dashboard: Variables initialized, setting up event listener");

      // Format date in Indian timezone
      function formatIndianTime(dateString) {
        if (!dateString) return '--';
        try {
          const date = new Date(dateString);
          return date.toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        } catch (e) {
          console.error('Date formatting error:', e);
          return '--';
        }
      }

      function formatIndianDate(dateString) {
        if (!dateString) return '--';
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });
        } catch (e) {
          console.error('Date formatting error:', e);
          return '--';
        }
      }

      // Safe value accessor with fallback
      function safeValue(obj, path, defaultVal = 0) {
        try {
          return path.split('.').reduce((acc, part) => acc && acc[part], obj) ?? defaultVal;
        } catch (e) {
          return defaultVal;
        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸ”§ RL Dashboard: DOMContentLoaded event fired");
        console.log("ðŸ”§ RL Dashboard: Calling loadRLPerformance()");
        loadRLPerformance();
        setInterval(loadRLPerformance, 60000); // Refresh every minute
      });

      function changePeriod(days, event) {
        currentPeriod = days;

        // Update button states
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        if (event && event.target) {
          event.target.classList.add("active");
        } else {
          // If no event, find and activate the button with matching data
          document.querySelectorAll(".time-btn").forEach((btn) => {
            if (btn.textContent.includes(days === 1 ? '24h' : days + ' days')) {
              btn.classList.add("active");
            }
          });
        }

        loadRLPerformance();
      }

      async function loadRLPerformance() {
        console.log(`ðŸ”§ Loading RL performance data for ${currentPeriod} days...`);
        
        // Show loading state
        const statusAlert = document.getElementById("statusAlert");
        statusAlert.className = "alert alert-custom";
        statusAlert.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <strong>Loading RL performance data...</strong>
          </div>
        `;
        
        try {
          const url = `/api/admin/analytics/rl-performance?days=${currentPeriod}`;
          console.log(`ðŸ”§ Fetching: ${url}`);
          
          // Add timeout to prevent infinite loading
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
          
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          console.log(`ðŸ”§ Response status: ${response.status}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error (${response.status}): ${errorText}`);
          }
          
          const result = await response.json();
          console.log("ðŸ”§ Response data:", result);

          if (result.success) {
            // Pass the entire result, not just result.data, so rl_enabled is included
            updateDashboard({
              ...result.data,
              rl_enabled: result.rl_enabled
            });
          } else {
            showError(result.error || 'Unknown error occurred');
          }
        } catch (error) {
          console.error("âŒ Error loading RL performance:", error);
          if (error.name === 'AbortError') {
            showError("Request timeout - server took too long to respond. Please try again with a shorter time period.");
          } else {
            showError("Failed to load data: " + error.message);
          }
        }
      }

      function updateDashboard(data) {
        console.log("ðŸ”§ updateDashboard called with data:", data);
        
        const performance = data.performance || {};
        const systemInfo = data.system_info || {};
        const trends = data.trends || {};
        const trainingHistory = data.training_history || [];

        // Update status banner
        const statusAlert = document.getElementById("statusAlert");
        const rlEnabled = data.rl_enabled !== undefined ? data.rl_enabled : false;
        
        console.log("ðŸ”§ RL Enabled status:", rlEnabled);
        console.log("ðŸ”§ System Info:", systemInfo);
        
        if (rlEnabled && systemInfo && Object.keys(systemInfo).length > 0) {
          statusAlert.className = "alert alert-custom alert-success";
          statusAlert.innerHTML = `
            <div class="d-flex align-items-center">
              <i class="bi bi-check-circle-fill me-3 fs-5"></i>
              <div>
                <strong>RL System Active</strong>
                <div class="small opacity-75">Last updated: ${formatIndianTime(new Date())}</div>
              </div>
            </div>
          `;
        } else {
          statusAlert.className = "alert alert-custom alert-warning";
          statusAlert.innerHTML = `
            <div class="d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
              <div>
                <strong>RL System Issue</strong>
                <div class="small">Check server logs or contact administrator</div>
              </div>
            </div>
          `;
        }

        // Update key metrics with safe accessors
        document.getElementById("avgReward").textContent =
          (safeValue(performance, 'avg_reward')).toFixed(2);
        document.getElementById("positiveRate").textContent =
          (safeValue(performance, 'positive_interaction_rate')).toFixed(1) + "%";
        document.getElementById("trainingExamples").textContent =
          Math.floor(safeValue(performance, 'total_training_examples'));
        document.getElementById("explorationRate").textContent =
          (safeValue(systemInfo, 'exploration_rate') * 100).toFixed(0) + "%";

        // Update change indicators
        updateChangeIndicator("rewardChange", safeValue(trends, 'reward_improvement', null));
        updateChangeIndicator("positiveChange", safeValue(trends, 'positive_rate_improvement', null));
        
        // Update examples change if available
        if (trends.examples_change !== undefined) {
          updateChangeIndicator("examplesChange", trends.examples_change);
        }

        // Update system configuration
        const isReallyEnabled = rlEnabled && systemInfo && Object.keys(systemInfo).length > 0;
        
        console.log("ðŸ”§ Setting RL Status badge - isReallyEnabled:", isReallyEnabled);
        
        document.getElementById("rlStatus").className = isReallyEnabled
          ? "status-badge status-enabled"
          : "status-badge status-disabled";
        document.getElementById("rlStatus").innerHTML = 
          '<i class="bi bi-circle-fill me-1"></i>' + (isReallyEnabled ? "Enabled" : "Disabled");
        
        if (systemInfo && Object.keys(systemInfo).length > 0) {
          document.getElementById("similarityWeight").textContent =
            (safeValue(systemInfo, 'similarity_weight') * 100).toFixed(0) + "%";
          document.getElementById("banditWeight").textContent =
            (safeValue(systemInfo, 'bandit_weight') * 100).toFixed(0) + "%";
        } else {
          document.getElementById("similarityWeight").textContent = "N/A";
          document.getElementById("banditWeight").textContent = "N/A";
        }

        // Update last training
        if (trainingHistory && trainingHistory.length > 0) {
          document.getElementById("lastTraining").textContent =
            formatIndianDate(trainingHistory[0].training_date || trainingHistory[0].training_timestamp);
        } else {
          document.getElementById("lastTraining").textContent = "No data";
        }

        // Update charts
        updateRewardChart(trainingHistory);
        updateCTRChart(trainingHistory);

        // Update top projects
        updateTopProjects(performance.top_projects || []);

        // Update training history table
        updateTrainingHistory(trainingHistory);
      }

      function updateChangeIndicator(elementId, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (value === undefined || value === null || value === 0) {
          element.className = "stat-change neutral";
          element.innerHTML = '<i class="bi bi-dash"></i> No change';
        } else if (value > 0) {
          element.className = "stat-change positive";
          element.innerHTML = `<i class="bi bi-arrow-up"></i> +${value.toFixed(1)}%`;
        } else {
          element.className = "stat-change negative";
          element.innerHTML = `<i class="bi bi-arrow-down"></i> ${value.toFixed(1)}%`;
        }
      }

      function updateRewardChart(history) {
        const ctx = document.getElementById("rewardTrendChart");
        if (!ctx) return;

        if (rewardChart) {
          rewardChart.destroy();
        }

        if (!history || history.length === 0) {
          // Show empty state
          return;
        }

        const data = history.slice().reverse();
        const labels = data.map((h) => formatIndianTime(h.training_timestamp || h.training_date));
        const rewards = data.map((h) => parseFloat(h.post_avg_reward) || 0);

        rewardChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Average Reward per Interaction",
                data: rewards,
                borderColor: "#2da44e",
                backgroundColor: "rgba(45, 164, 78, 0.1)",
                tension: 0.3,
                borderWidth: 2,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Avg Reward: ' + context.parsed.y.toFixed(2);
                  },
                  afterLabel: function(context) {
                    return 'Training improved model with recent user feedback';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                title: {
                  display: true,
                  text: 'Reward Score'
                }
              },
              x: {
                grid: { display: false },
                title: {
                  display: true,
                  text: 'Training Sessions (progression over time)'
                }
              }
            },
          },
        });
      }

      function updateCTRChart(history) {
        const ctx = document.getElementById("ctrTrendChart");
        if (!ctx) return;

        if (ctrChart) {
          ctrChart.destroy();
        }

        if (!history || history.length === 0) {
          return;
        }

        const data = history.slice().reverse();
        const labels = data.map((h) => formatIndianTime(h.training_timestamp || h.training_date));
        const positiveRates = data.map((h) => parseFloat(h.post_positive_rate) || 0);

        ctrChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Positive Interaction Rate",
                data: positiveRates,
                backgroundColor: "#0969da",
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Positive Rate: ' + context.parsed.y.toFixed(2) + '%';
                  },
                  afterLabel: function(context) {
                    return 'Higher is better - shows user engagement';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                title: {
                  display: true,
                  text: 'Positive Interaction %'
                },
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              x: {
                grid: { display: false },
                title: {
                  display: true,
                  text: 'Training Sessions'
                }
              }
            },
          },
        });
      }

      function updateTopProjects(projects) {
        const tbody = document.getElementById("topProjectsTable")?.querySelector("tbody");
        if (!tbody) return;

        if (!projects || projects.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-muted">No project data available yet</td></tr>';
          return;
        }

        tbody.innerHTML = projects
          .map((project, index) => {
            const rank = index + 1;
            const rankClass =
              rank === 1 ? "rank-1" : rank === 2 ? "rank-2" : rank === 3 ? "rank-3" : "rank-other";
            const successRate = parseFloat(project.success_rate) || 0;
            const totalInteractions = parseInt(project.total_interactions) || 0;
            const avgReward = parseFloat(project.avg_reward) || 0;

            return `
              <tr>
                <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                <td><strong>${project.title || "Unknown Project"}</strong></td>
                <td>
                  <div class="progress" style="height: 6px; background-color: #f0f0f0;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: ${successRate}%; background-color: #2da44e !important;"
                         aria-valuenow="${successRate}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
                  <small class="text-muted" style="font-size: 0.75rem">${successRate.toFixed(1)}%</small>
                </td>
                <td>${totalInteractions}</td>
                <td><span class="badge" style="background-color: #0969da">${avgReward.toFixed(2)}</span></td>
              </tr>
            `;
          })
          .join("");
      }

      function updateTrainingHistory(history) {
        const tbody = document.getElementById("trainingHistoryTable")?.querySelector("tbody");
        if (!tbody) return;

        if (!history || history.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-3 text-muted">No training history available. Trigger manual training to start collecting data.</td></tr>';
          return;
        }

        tbody.innerHTML = history
          .slice(0, 10)
          .map((record) => {
            const timestamp = formatIndianTime(record.training_timestamp || record.training_date);
            const postReward = parseFloat(record.post_avg_reward) || 0;
            const positiveRate = parseFloat(record.post_positive_rate) || 0;
            const projectsUpdated = parseInt(record.projects_updated) || 0;
            
            // Calculate duration from notes if available
            let duration = '--';
            if (record.notes && record.notes.includes('Completed in')) {
              const match = record.notes.match(/Completed in ([\d.]+)s/);
              if (match) {
                duration = match[1] + 's';
              }
            }

            return '<tr>' +
                        '<td>' + timestamp + '</td>' +
                        '<td><span class="badge bg-success">' + postReward.toFixed(2) + '</span></td>' +
                        '<td><span class="badge bg-primary">' + positiveRate.toFixed(1) + '%</span></td>' +
                        '<td>' + projectsUpdated + '</td>' +
                        '<td class="text-muted small">' + duration + '</td>' +
                    '</tr>';
          })
          .join("");
      }

      async function triggerTraining() {
        if (
          !confirm(
            "Trigger manual RL training? This will process recent interactions and update the model."
          )
        ) {
          return;
        }

        const loadingOverlay = document.getElementById("loadingOverlay");
        if (loadingOverlay) {
          loadingOverlay.style.display = "flex";
        }

        try {
          const response = await fetch("/api/admin/rl/trigger-training", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ days: currentPeriod }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            const avgReward = safeValue(result, 'performance.avg_reward', 0);
            alert(
              "Training completed successfully!\n\nAvg Reward: " + avgReward.toFixed(2)
            );
            loadRLPerformance();
          } else {
            alert("Training failed: " + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error("Error triggering training:", error);
          alert("Failed to trigger training: " + error.message);
        } finally {
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
        }
      }

      function showError(message) {
        const statusAlert = document.getElementById("statusAlert");
        if (!statusAlert) return;
        
        statusAlert.className = "alert alert-custom alert-danger";
        statusAlert.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
            <strong>Error: ${message}</strong>
          </div>
        `;
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}