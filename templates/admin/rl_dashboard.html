<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RL Performance Dashboard - CoChain.ai Admin</title>

    <!-- Tailwind CSS for navbar -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap CSS for dashboard -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      :root {
        --primary-color: #6366f1;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-bg: #1f2937;
        --card-bg: #ffffff;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* Navbar Dropdown */
      .dropdown {
        position: relative;
      }

      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        margin-top: 0.25rem;
        width: 12rem;
        background-color: white;
        border-radius: 0.375rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 0.25rem 0;
        z-index: 9999;
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown:hover .dropdown-menu {
        display: block;
      }

      /* Add invisible bridge between button and dropdown */
      .dropdown::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        height: 0.5rem;
        z-index: 9998;
      }

      .navbar {
        background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        border: 1px solid #e5e7eb;
      }

      .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 8px 0;
      }

      .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
      }

      .stat-change {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
        display: inline-block;
        margin-top: 8px;
      }

      .stat-change.positive {
        background: #d1fae5;
        color: #065f46;
      }

      .stat-change.negative {
        background: #fee2e2;
        color: #991b1b;
      }

      .stat-change.neutral {
        background: #e5e7eb;
        color: #374151;
      }

      .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
      }

      .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #111827;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
      }

      .status-enabled {
        background: #d1fae5;
        color: #065f46;
      }

      .status-disabled {
        background: #fee2e2;
        color: #991b1b;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .btn-train {
        background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
        border: none;
        color: white;
        font-weight: 600;
        padding: 10px 24px;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .btn-train:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      }

      .top-projects-table {
        font-size: 0.875rem;
      }

      .top-projects-table th {
        background: #f9fafb;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #6b7280;
        border-bottom: 2px solid #e5e7eb;
      }

      .top-projects-table td {
        vertical-align: middle;
        padding: 12px;
      }

      .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.875rem;
      }

      .rank-1 {
        background: #fef3c7;
        color: #92400e;
      }
      .rank-2 {
        background: #e5e7eb;
        color: #1f2937;
      }
      .rank-3 {
        background: #fed7aa;
        color: #9a3412;
      }
      .rank-other {
        background: #f3f4f6;
        color: #6b7280;
      }

      .config-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid var(--primary-color);
      }

      .config-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .config-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
      }

      .alert-custom {
        border-radius: 8px;
        border: none;
        padding: 16px;
      }

      .time-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
      }

      .time-btn {
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .time-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      .time-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-2">
            <i class="fas fa-link text-2xl"></i>
            <a href="/" class="text-2xl font-bold hover:opacity-90 transition"
              >CoChain.ai</a
            >
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-6">
            {% if user_id %}
            <!-- Logged in user navigation -->
            <a
              href="{{ url_for('dashboard') }}"
              class="hover:text-gray-200 transition"
            >
              <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
            </a>
            <a
              href="{{ url_for('explore') }}"
              class="hover:text-gray-200 transition"
            >
              <i class="fas fa-compass mr-1"></i> Explore
            </a>
            <a
              href="{{ url_for('bookmarks') }}"
              class="hover:text-gray-200 transition"
            >
              <i class="fas fa-bookmark mr-1"></i> Bookmarks
            </a>

            <!-- User Info Dropdown -->
            <div class="relative dropdown">
              <button
                id="userMenuButton"
                type="button"
                class="flex items-center space-x-2 hover:text-gray-200 transition"
              >
                <i class="fas fa-user-circle text-xl"></i>
                <span class="hidden lg:block">{{ user_name or 'User' }}</span>
                <i class="fas fa-chevron-down text-xs"></i>
              </button>

              <!-- Dropdown Menu -->
              <div
                id="userMenuDropdown"
                class="dropdown-menu absolute right-0 mt-1 w-48 bg-white rounded-md shadow-lg py-1 z-50"
              >
                <a
                  href="{{ url_for('profile_setup') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition"
                >
                  <i class="fas fa-user mr-2"></i> Profile
                </a>
                {% if is_admin %}
                <div class="border-t border-gray-100"></div>
                <div
                  class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase"
                >
                  Admin
                </div>
                <a
                  href="{{ url_for('admin_analytics') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition"
                >
                  <i class="fas fa-chart-line mr-2"></i> Analytics
                </a>
                <a
                  href="{{ url_for('admin_users') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition"
                >
                  <i class="fas fa-users mr-2"></i> Users
                </a>
                {% endif %}
                <div class="border-t border-gray-100"></div>
                <a
                  href="{{ url_for('logout') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition"
                >
                  <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </a>
              </div>
            </div>
            {% else %}
            <!-- Not logged in navigation -->
            <a
              href="{{ url_for('index') }}"
              class="hover:text-gray-200 transition"
            >
              <i class="fas fa-home mr-1"></i> Home
            </a>
            <a
              href="{{ url_for('login') }}"
              class="hover:text-gray-200 transition"
            >
              <i class="fas fa-sign-in-alt mr-1"></i> Login
            </a>
            <a
              href="{{ url_for('register') }}"
              class="bg-white text-purple-600 px-4 py-2 rounded-md hover:bg-gray-100 transition font-semibold"
            >
              <i class="fas fa-user-plus mr-1"></i> Sign Up
            </a>
            {% endif %}
          </div>

          <!-- Mobile Menu Button -->
          <button id="mobile-menu-btn" class="md:hidden focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
          {% if user_id %}
          <!-- Logged in mobile menu -->
          <div class="py-2 border-b border-purple-400 mb-2">
            <span class="text-purple-200 text-sm">
              <i class="fas fa-user-circle mr-2"></i>{{ user_name or 'User' }}
            </span>
          </div>
          <a
            href="{{ url_for('dashboard') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
          </a>
          <a
            href="{{ url_for('explore') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-compass mr-2"></i> Explore
          </a>
          <a
            href="{{ url_for('bookmarks') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-bookmark mr-2"></i> Bookmarks
          </a>
          <a
            href="{{ url_for('profile_setup') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-user mr-2"></i> Profile
          </a>
          {% if is_admin %}
          <div class="border-t border-purple-400 mt-2 pt-2"></div>
          <div class="text-xs font-semibold text-purple-200 uppercase mb-2">
            Admin
          </div>
          <a
            href="{{ url_for('admin_analytics') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-chart-line mr-2"></i> Analytics
          </a>
          <a
            href="{{ url_for('admin_users') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-users mr-2"></i> Users
          </a>
          {% endif %}
          <a
            href="{{ url_for('logout') }}"
            class="block py-2 hover:text-gray-200 transition border-t border-purple-400 mt-2 pt-4"
          >
            <i class="fas fa-sign-out-alt mr-2"></i> Logout
          </a>
          {% else %}
          <!-- Not logged in mobile menu -->
          <a
            href="{{ url_for('index') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-home mr-2"></i> Home
          </a>
          <a
            href="{{ url_for('login') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-sign-in-alt mr-2"></i> Login
          </a>
          <a
            href="{{ url_for('register') }}"
            class="block py-2 hover:text-gray-200 transition"
          >
            <i class="fas fa-user-plus mr-2"></i> Sign Up
          </a>
          {% endif %}
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="text-3xl font-bold text-gray-800">
            RL Performance Dashboard
          </h1>
        </div>
      </div>

      <!-- Status Banner -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="alert alert-custom" id="statusAlert" role="alert">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <strong>Loading RL performance data...</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Time Period Selector -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="time-selector">
            <button class="time-btn" onclick="changePeriod(1)">Last 24h</button>
            <button class="time-btn active" onclick="changePeriod(7)">
              Last 7 days
            </button>
            <button class="time-btn" onclick="changePeriod(30)">
              Last 30 days
            </button>
            <button class="time-btn" onclick="changePeriod(90)">
              Last 90 days
            </button>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-graph-up me-2"></i>Average Reward
            </div>
            <div class="stat-value text-primary" id="avgReward">--</div>
            <span class="stat-change" id="rewardChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-hand-thumbs-up me-2"></i>Positive Rate
            </div>
            <div class="stat-value text-success" id="positiveRate">--</div>
            <span class="stat-change" id="positiveChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-collection me-2"></i>Training Examples
            </div>
            <div class="stat-value text-info" id="trainingExamples">--</div>
            <span class="stat-change" id="examplesChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-lightning-charge me-2"></i>Exploration Rate
            </div>
            <div class="stat-value text-warning" id="explorationRate">--</div>
            <span class="stat-change neutral">Current</span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <!-- Reward Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              <i class="bi bi-graph-up-arrow me-2"></i>Reward Trend Over Time
            </h5>
            <canvas id="rewardTrendChart"></canvas>
          </div>
        </div>

        <!-- CTR Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              <i class="bi bi-cursor-fill me-2"></i>Click-Through Rate
              Improvement
            </h5>
            <canvas id="ctrTrendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Top Projects & Configuration -->
      <div class="row mb-4">
        <!-- Top Performing Projects -->
        <div class="col-md-8">
          <div class="chart-card">
            <h5 class="chart-title">
              <i class="bi bi-trophy me-2"></i>Top Performing Projects
            </h5>
            <div class="table-responsive">
              <table class="table top-projects-table" id="topProjectsTable">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Project</th>
                    <th>Success Rate</th>
                    <th>Total Interactions</th>
                    <th>Avg Reward</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- System Configuration -->
        <div class="col-md-4">
          <div class="chart-card">
            <h5 class="chart-title">
              <i class="bi bi-gear me-2"></i>System Configuration
            </h5>

            <div class="config-card">
              <div class="config-label">RL Status</div>
              <div class="config-value">
                <span class="status-badge" id="rlStatus">
                  <i class="bi bi-circle-fill me-1"></i>Loading...
                </span>
              </div>
            </div>

            <div class="config-card">
              <div class="config-label">Similarity Weight</div>
              <div class="config-value" id="similarityWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Bandit Weight</div>
              <div class="config-value" id="banditWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Last Training</div>
              <div
                class="config-value"
                id="lastTraining"
                style="font-size: 1rem"
              >
                --
              </div>
            </div>

            <div class="alert alert-info alert-custom mt-3">
              <small>
                <i class="bi bi-info-circle me-2"></i>
                <strong>Next Training:</strong> Scheduled for 2:00 AM daily
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Training History -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="chart-card">
            <h5 class="chart-title">
              <i class="bi bi-clock-history me-2"></i>Recent Training History
            </h5>
            <div class="table-responsive">
              <table class="table table-sm" id="trainingHistoryTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Pre-Reward</th>
                    <th>Post-Reward</th>
                    <th>Improvement</th>
                    <th>Examples</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6" class="text-center py-3">
                      <div
                        class="spinner-border spinner-border-sm text-primary"
                        role="status"
                      >
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Trigger Training Button -->
      <div class="row mt-4 mb-4">
        <div class="col-12 text-end">
          <button class="btn btn-train btn-lg" onclick="triggerTraining()">
            <i class="bi bi-lightning-charge me-2"></i>Trigger Training
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none">
      <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div><strong>Processing...</strong></div>
        <div class="text-muted mt-2">This may take a few moments</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentPeriod = 7;
      let rewardChart, ctrChart;

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadRLPerformance();
        setInterval(loadRLPerformance, 60000); // Refresh every minute
      });

      function changePeriod(days) {
        currentPeriod = days;

        // Update button states
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        loadRLPerformance();
      }

      async function loadRLPerformance() {
        try {
          const response = await fetch(
            `/api/admin/analytics/rl-performance?days=${currentPeriod}`
          );
          const result = await response.json();

          if (result.success) {
            updateDashboard(result.data);
          } else {
            showError(result.error);
          }
        } catch (error) {
          console.error("Error loading RL performance:", error);
          showError("Failed to load RL performance data");
        }
      }

      function updateDashboard(data) {
        const performance = data.performance;
        const systemInfo = data.system_info;
        const trends = data.trends;
        const trainingHistory = data.training_history;

        // Update status banner
        const statusAlert = document.getElementById("statusAlert");
        if (data.rl_enabled) {
          statusAlert.className = "alert alert-custom alert-success";
          statusAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                        <div>
                            <strong>RL System Active</strong>
                            <div class="small">Last updated: ${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
        } else {
          statusAlert.className = "alert alert-custom alert-warning";
          statusAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                        <strong>RL System Disabled</strong>
                    </div>
                `;
        }

        // Update key metrics
        document.getElementById("avgReward").textContent =
          performance.avg_reward?.toFixed(2) || "0.00";
        document.getElementById("positiveRate").textContent =
          (performance.positive_interaction_rate?.toFixed(1) || "0.0") + "%";
        document.getElementById("trainingExamples").textContent =
          performance.total_training_examples || 0;
        document.getElementById("explorationRate").textContent =
          ((systemInfo.exploration_rate || 0) * 100).toFixed(0) + "%";

        // Update change indicators
        updateChangeIndicator("rewardChange", trends.reward_improvement);
        updateChangeIndicator("positiveChange", trends.ctr_improvement);

        // Update system configuration
        document.getElementById("rlStatus").className = data.rl_enabled
          ? "status-badge status-enabled"
          : "status-badge status-disabled";
        document.getElementById(
          "rlStatus"
        ).innerHTML = `<i class="bi bi-circle-fill me-1"></i>${
          data.rl_enabled ? "Enabled" : "Disabled"
        }`;
        document.getElementById("similarityWeight").textContent =
          ((systemInfo.similarity_weight || 0) * 100).toFixed(0) + "%";
        document.getElementById("banditWeight").textContent =
          ((systemInfo.bandit_weight || 0) * 100).toFixed(0) + "%";

        // Update last training
        if (trainingHistory && trainingHistory.length > 0) {
          const lastTraining = new Date(trainingHistory[0].training_date);
          document.getElementById("lastTraining").textContent =
            lastTraining.toLocaleDateString();
        }

        // Update charts
        updateRewardChart(trainingHistory);
        updateCTRChart(trainingHistory);

        // Update top projects
        updateTopProjects(performance.top_projects);

        // Update training history table
        updateTrainingHistory(trainingHistory);
      }

      function updateChangeIndicator(elementId, value) {
        const element = document.getElementById(elementId);
        if (value === undefined || value === null || value === 0) {
          element.className = "stat-change neutral";
          element.innerHTML = '<i class="bi bi-dash"></i> No change';
        } else if (value > 0) {
          element.className = "stat-change positive";
          element.innerHTML = `<i class="bi bi-arrow-up"></i> +${value.toFixed(
            1
          )}%`;
        } else {
          element.className = "stat-change negative";
          element.innerHTML = `<i class="bi bi-arrow-down"></i> ${value.toFixed(
            1
          )}%`;
        }
      }

      function updateRewardChart(history) {
        const ctx = document
          .getElementById("rewardTrendChart")
          .getContext("2d");

        if (rewardChart) {
          rewardChart.destroy();
        }

        const data = history.slice().reverse();
        const labels = data.map((h) =>
          new Date(h.training_date).toLocaleDateString()
        );
        const preRewards = data.map((h) => h.pre_avg_reward || 0);
        const postRewards = data.map((h) => h.post_avg_reward || 0);

        rewardChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pre-Training",
                data: preRewards,
                borderColor: "#f59e0b",
                backgroundColor: "rgba(245, 158, 11, 0.1)",
                tension: 0.4,
              },
              {
                label: "Post-Training",
                data: postRewards,
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function updateCTRChart(history) {
        const ctx = document.getElementById("ctrTrendChart").getContext("2d");

        if (ctrChart) {
          ctrChart.destroy();
        }

        const data = history.slice().reverse();
        const labels = data.map((h) =>
          new Date(h.training_date).toLocaleDateString()
        );
        const ctrValues = data.map((h) => h.post_avg_ctr || 0);

        ctrChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "CTR %",
                data: ctrValues,
                backgroundColor: "#6366f1",
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
            },
          },
        });
      }

      function updateTopProjects(projects) {
        const tbody = document
          .getElementById("topProjectsTable")
          .querySelector("tbody");

        if (!projects || projects.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-muted">No project data available yet</td></tr>';
          return;
        }

        tbody.innerHTML = projects
          .map((project, index) => {
            const rank = index + 1;
            const rankClass =
              rank === 1
                ? "rank-1"
                : rank === 2
                ? "rank-2"
                : rank === 3
                ? "rank-3"
                : "rank-other";
            const successRate = project.success_rate || 0;
            const totalInteractions = project.total_interactions || 0;
            const avgReward = project.avg_reward || 0;

            return `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td><strong>${
                          project.title || "Unknown Project"
                        }</strong></td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: ${successRate}%"
                                     aria-valuenow="${successRate}" aria-valuemin="0" aria-valuemax="100">
                                    ${successRate.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                        <td>${totalInteractions}</td>
                        <td><span class="badge bg-primary">${avgReward.toFixed(
                          2
                        )}</span></td>
                    </tr>
                `;
          })
          .join("");
      }

      function updateTrainingHistory(history) {
        const tbody = document
          .getElementById("trainingHistoryTable")
          .querySelector("tbody");

        if (!history || history.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center py-3 text-muted">No training history available</td></tr>';
          return;
        }

        tbody.innerHTML = history
          .slice(0, 10)
          .map((record) => {
            const date = new Date(record.training_date).toLocaleDateString();
            const improvement = record.reward_improvement || 0;
            const improvementClass =
              improvement > 0
                ? "text-success"
                : improvement < 0
                ? "text-danger"
                : "text-muted";

            return `
                    <tr>
                        <td>${date}</td>
                        <td>${record.pre_avg_reward?.toFixed(2) || "0.00"}</td>
                        <td>${record.post_avg_reward?.toFixed(2) || "0.00"}</td>
                        <td class="${improvementClass}">
                            <strong>${
                              improvement > 0 ? "+" : ""
                            }${improvement.toFixed(2)}%</strong>
                        </td>
                        <td>${record.projects_updated || 0}</td>
                        <td>${record.notes || "--"}</td>
                    </tr>
                `;
          })
          .join("");
      }

      async function triggerTraining() {
        if (
          !confirm(
            "Trigger manual RL training? This will process recent interactions and update the model."
          )
        ) {
          return;
        }

        document.getElementById("loadingOverlay").style.display = "flex";

        try {
          const response = await fetch("/api/admin/rl/trigger-training", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ days: currentPeriod }),
          });

          const result = await response.json();

          if (result.success) {
            alert(
              "Training completed successfully!\n\nAvg Reward: " +
                (result.performance.avg_reward || 0).toFixed(2)
            );
            loadRLPerformance();
          } else {
            alert("Training failed: " + result.error);
          }
        } catch (error) {
          console.error("Error triggering training:", error);
          alert("Failed to trigger training: " + error.message);
        } finally {
          document.getElementById("loadingOverlay").style.display = "none";
        }
      }

      function showError(message) {
        const statusAlert = document.getElementById("statusAlert");
        statusAlert.className = "alert alert-custom alert-danger";
        statusAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                    <strong>Error: ${message}</strong>
                </div>
            `;
      }

      function showToast(message, type = "success") {
        // Simple toast notification (you can enhance this)
        alert(message);
      }
    </script>

    <!-- Mobile menu toggle script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");

        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener("click", function () {
            mobileMenu.classList.toggle("hidden");
          });
        }

        // Desktop dropdown hover functionality with delay
        const userDropdown = document.querySelector(".dropdown");
        const userMenuDropdown = document.getElementById("userMenuDropdown");
        let hideTimeout;

        if (userDropdown && userMenuDropdown) {
          userDropdown.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
            userMenuDropdown.classList.add("show");
          });

          userDropdown.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(function () {
              userMenuDropdown.classList.remove("show");
            }, 200);
          });

          userMenuDropdown.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
            userMenuDropdown.classList.add("show");
          });

          userMenuDropdown.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(function () {
              userMenuDropdown.classList.remove("show");
            }, 200);
          });
        }

        // Close mobile menu when clicking outside
        document.addEventListener("click", function (event) {
          if (mobileMenu && !mobileMenu.classList.contains("hidden")) {
            if (
              !mobileMenuBtn.contains(event.target) &&
              !mobileMenu.contains(event.target)
            ) {
              mobileMenu.classList.add("hidden");
            }
          }
        });
      });
    </script>
  </body>
</html>
