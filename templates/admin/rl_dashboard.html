<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RL Performance Dashboard - CoChain.ai Admin</title>

    <!-- Tailwind CSS (Utility) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap CSS (Grid System) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      /* GitHub Primer Variables */
      :root {
        --gh-bg: #f6f8fa;
        --gh-border: #d0d7de;
        --gh-text-main: #24292f;
        --gh-text-muted: #57606a;
        --gh-blue: #0969da;
        --gh-green: #2da44e;
        --gh-red: #cf222e;
        --gh-orange: #9a6700;
        --gh-card-bg: #ffffff;
      }

      body {
        background-color: var(--gh-bg);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        color: var(--gh-text-main);
        margin: 0;
        padding: 0;
      }

      /* Navbar Overrides */
      .navbar-gh {
        background-color: #24292f;
        color: white;
      }

      /* Dropdown Logic */
      .dropdown { position: relative; }
      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        margin-top: 0.5rem;
        width: 12rem;
        background-color: white;
        border: 1px solid var(--gh-border);
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(140,149,159,0.2);
        padding: 4px 0;
        z-index: 9999;
      }
      .dropdown-menu.show { display: block; }
      .dropdown:hover .dropdown-menu { display: block; }
      .dropdown::after {
        content: "";
        position: absolute;
        top: 100%; left: 0; right: 0; height: 0.5rem; z-index: 9998;
      }

      /* Dashboard Cards */
      .stat-card, .chart-card {
        background: var(--gh-card-bg);
        border: 1px solid var(--gh-border);
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.02);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 600;
        margin: 4px 0;
        color: var(--gh-text-main);
      }

      .stat-label {
        color: var(--gh-text-muted);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .stat-change {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
        margin-top: 4px;
        border: 1px solid transparent;
      }

      .stat-change.positive { background: #dafbe1; color: #1a7f37; border-color: rgba(26,127,55,0.1); }
      .stat-change.negative { background: #ffebe9; color: #cf222e; border-color: rgba(207,34,46,0.1); }
      .stat-change.neutral { background: #f6f8fa; color: #57606a; border-color: #d0d7de; }

      .chart-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--gh-text-main);
        border-bottom: 1px solid var(--gh-border);
        padding-bottom: 12px;
      }

      /* Status Badges */
      .status-badge {
        padding: 4px 10px;
        border-radius: 2em;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        border: 1px solid transparent;
      }
      .status-enabled { background: #dafbe1; color: #1a7f37; border-color: rgba(26,127,55,0.2); }
      .status-disabled { background: #ffebe9; color: #cf222e; border-color: rgba(207,34,46,0.2); }

      /* Buttons */
      .btn-train {
        background-color: var(--gh-green);
        border: 1px solid rgba(27,31,36,0.15);
        color: white;
        font-weight: 600;
        padding: 6px 16px;
        border-radius: 6px;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-train:hover {
        background-color: #2c974b;
        color: white;
      }

      /* Time Selector (Segmented Control) */
      .time-selector {
        display: inline-flex;
        background: #f6f8fa;
        border: 1px solid var(--gh-border);
        border-radius: 6px;
        padding: 2px;
      }
      .time-btn {
        padding: 4px 12px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.85rem;
        color: var(--gh-text-main);
        border-radius: 4px;
      }
      .time-btn:hover { background: rgba(0,0,0,0.05); }
      .time-btn.active {
        background: white;
        color: var(--gh-blue);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        font-weight: 600;
      }

      /* Tables */
      .top-projects-table th {
        background: #f6f8fa;
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--gh-text-muted);
        border-bottom: 1px solid var(--gh-border);
        text-transform: uppercase;
      }
      .top-projects-table td {
        vertical-align: middle;
        padding: 10px;
        font-size: 0.9rem;
        border-bottom: 1px solid #eaeef2;
      }

      /* Rank Badges */
      .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.75rem;
        border: 1px solid rgba(0,0,0,0.1);
      }
      .rank-1 { background: #fff8c5; color: #9a6700; }
      .rank-2 { background: #f6f8fa; color: #57606a; }
      .rank-3 { background: #f3f4f6; color: #57606a; }
      .rank-other { background: transparent; color: #57606a; border: none; }

      /* Config Cards */
      .config-card {
        background: #f6f8fa;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid var(--gh-border);
      }
      .config-label { font-size: 0.75rem; color: var(--gh-text-muted); }
      .config-value { font-size: 1.1rem; font-weight: 600; color: var(--gh-text-main); }

      /* Alerts */
      .alert-custom {
        background: #ddf4ff;
        border: 1px solid rgba(84,174,255,0.4);
        color: #0969da;
        border-radius: 6px;
        padding: 16px;
      }
      .alert-success { background: #dafbe1; border-color: rgba(74,194,107,0.4); color: #1a7f37; }
      .alert-warning { background: #fff8c5; border-color: rgba(212,167,44,0.4); color: #9a6700; }
      .alert-danger { background: #ffebe9; border-color: rgba(255,129,130,0.4); color: #cf222e; }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(2px);
        display: flex; align-items: center; justify-content: center; z-index: 9999;
      }
      .loading-spinner {
        background: white; padding: 24px; border-radius: 6px;
        box-shadow: 0 8px 24px rgba(140,149,159,0.2);
        border: 1px solid var(--gh-border);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Navigation - GitHub Dark Header -->
    <nav class="bg-gray-900 text-white shadow-sm">
      <div class="container mx-auto px-6 py-3">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <i class="fab fa-github text-3xl"></i>
            <a href="/" class="text-lg font-bold hover:text-gray-300 transition"
              >CoChain.ai</a
            >
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-6 text-sm font-semibold">
            {% if user_id %}
            <!-- Logged in user navigation -->
            <a
              href="{{ url_for('dashboard') }}"
              class="hover:text-gray-300 transition"
            >
              Dashboard
            </a>
            <a
              href="{{ url_for('explore') }}"
              class="hover:text-gray-300 transition"
            >
              Explore
            </a>
            <a
              href="{{ url_for('bookmarks') }}"
              class="hover:text-gray-300 transition"
            >
              Bookmarks
            </a>

            <!-- User Info Dropdown -->
            <div class="relative dropdown">
              <button
                id="userMenuButton"
                type="button"
                class="flex items-center space-x-2 hover:text-gray-300 transition"
              >
                <div class="w-5 h-5 rounded-full bg-gray-700 border border-gray-600 flex items-center justify-center text-xs">
                    <i class="fas fa-user"></i>
                </div>
                <span class="hidden lg:block">{{ user_name or 'User' }}</span>
                <i class="fas fa-caret-down text-xs text-gray-400"></i>
              </button>

              <!-- Dropdown Menu -->
              <div
                id="userMenuDropdown"
                class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl py-1 z-50 border border-gray-200"
              >
                <a
                  href="{{ url_for('profile_setup') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                   Profile
                </a>
                {% if is_admin %}
                <div class="border-t border-gray-100 my-1"></div>
                <div
                  class="px-4 py-1 text-xs font-semibold text-gray-500 uppercase"
                >
                  Admin
                </div>
                <a
                  href="{{ url_for('admin_analytics') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition bg-gray-50 font-semibold"
                >
                   Analytics
                </a>
                <a
                  href="{{ url_for('admin_users') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                   Users
                </a>
                {% endif %}
                <div class="border-t border-gray-100 my-1"></div>
                <a
                  href="{{ url_for('logout') }}"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-600 hover:text-white transition"
                >
                   Sign out
                </a>
              </div>
            </div>
            {% else %}
            <!-- Not logged in navigation -->
            <a
              href="{{ url_for('index') }}"
              class="hover:text-gray-300 transition"
            >
              Home
            </a>
            <a
              href="{{ url_for('login') }}"
              class="hover:text-gray-300 transition"
            >
              Sign In
            </a>
            <a
              href="{{ url_for('register') }}"
              class="border border-gray-100 text-white px-3 py-1.5 rounded-md hover:border-gray-300 hover:text-gray-200 transition font-semibold text-sm"
            >
              Sign Up
            </a>
            {% endif %}
          </div>

          <!-- Mobile Menu Button -->
          <button id="mobile-menu-btn" class="md:hidden focus:outline-none text-gray-300">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2 border-t border-gray-700 pt-4">
          <!-- Mobile menu content same as other pages -->
          <a href="{{ url_for('dashboard') }}" class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300">Dashboard</a>
          <a href="{{ url_for('logout') }}" class="block py-2 px-2 hover:bg-gray-800 rounded text-gray-300">Sign Out</a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4 px-4 px-md-5">
      <!-- Page Header -->
      <div class="row mb-4 align-items-center">
        <div class="col-md-6">
          <h1 class="h3 font-bold text-gray-900">
            RL Performance Dashboard
          </h1>
          <p class="text-gray-500 text-sm mb-0">Monitor model rewards and training metrics</p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
             <div class="time-selector">
                <button class="time-btn" onclick="changePeriod(1)">24h</button>
                <button class="time-btn active" onclick="changePeriod(7)">7 days</button>
                <button class="time-btn" onclick="changePeriod(30)">30 days</button>
                <button class="time-btn" onclick="changePeriod(90)">90 days</button>
            </div>
        </div>
      </div>

      <!-- Status Banner -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="alert alert-custom" id="statusAlert" role="alert">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <strong>Loading RL performance data...</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-graph-up me-1"></i> Average Reward
            </div>
            <div class="stat-value" id="avgReward">--</div>
            <span class="stat-change" id="rewardChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-hand-thumbs-up me-1"></i> Positive Rate
            </div>
            <div class="stat-value" id="positiveRate">--</div>
            <span class="stat-change" id="positiveChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-collection me-1"></i> Training Examples
            </div>
            <div class="stat-value" id="trainingExamples">--</div>
            <span class="stat-change" id="examplesChange">--</span>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-label">
              <i class="bi bi-lightning-charge me-1"></i> Exploration Rate
            </div>
            <div class="stat-value" id="explorationRate">--</div>
            <span class="stat-change neutral">Current</span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <!-- Reward Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              Reward Trend Over Time
            </h5>
            <canvas id="rewardTrendChart"></canvas>
          </div>
        </div>

        <!-- CTR Trend -->
        <div class="col-md-6">
          <div class="chart-card">
            <h5 class="chart-title">
              CTR Improvement
            </h5>
            <canvas id="ctrTrendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Top Projects & Configuration -->
      <div class="row mb-4">
        <!-- Top Performing Projects -->
        <div class="col-md-8">
          <div class="chart-card">
            <h5 class="chart-title">
              Top Performing Projects
            </h5>
            <div class="table-responsive">
              <table class="table top-projects-table" id="topProjectsTable">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Project</th>
                    <th>Success Rate</th>
                    <th>Interactions</th>
                    <th>Avg Reward</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- System Configuration -->
        <div class="col-md-4">
          <div class="chart-card">
            <h5 class="chart-title">
              System Configuration
            </h5>

            <div class="config-card">
              <div class="config-label">RL Status</div>
              <div class="mt-1">
                <span class="status-badge" id="rlStatus">
                  <i class="bi bi-circle-fill me-1"></i>Loading...
                </span>
              </div>
            </div>

            <div class="config-card">
              <div class="config-label">Similarity Weight</div>
              <div class="config-value" id="similarityWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Bandit Weight</div>
              <div class="config-value" id="banditWeight">--</div>
            </div>

            <div class="config-card">
              <div class="config-label">Last Training</div>
              <div
                class="config-value"
                id="lastTraining"
                style="font-size: 1rem"
              >
                --
              </div>
            </div>

            <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded text-xs text-blue-700">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Next Training:</strong> 2:00 AM daily
            </div>
          </div>
        </div>
      </div>

      <!-- Training History -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="chart-card">
            <h5 class="chart-title">
              Recent Training History
            </h5>
            <div class="table-responsive">
              <table class="table table-sm top-projects-table" id="trainingHistoryTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Pre-Reward</th>
                    <th>Post-Reward</th>
                    <th>Improvement</th>
                    <th>Examples</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6" class="text-center py-3">
                      <div
                        class="spinner-border spinner-border-sm text-primary"
                        role="status"
                      >
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Trigger Training Button -->
      <div class="row mt-4 mb-5">
        <div class="col-12 text-end">
          <button class="btn btn-train" onclick="triggerTraining()">
            <i class="bi bi-lightning-charge me-2"></i>Trigger Manual Training
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none">
      <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="font-bold text-gray-800">Processing</div>
        <div class="text-xs text-gray-500 mt-1">This may take a few moments</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentPeriod = 7;
      let rewardChart, ctrChart;

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadRLPerformance();
        setInterval(loadRLPerformance, 60000); // Refresh every minute
      });

      function changePeriod(days) {
        currentPeriod = days;

        // Update button states
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        loadRLPerformance();
      }

      async function loadRLPerformance() {
        try {
          const response = await fetch(
            `/api/admin/analytics/rl-performance?days=${currentPeriod}`
          );
          const result = await response.json();

          if (result.success) {
            updateDashboard(result.data);
          } else {
            showError(result.error);
          }
        } catch (error) {
          console.error("Error loading RL performance:", error);
          showError("Failed to load RL performance data");
        }
      }

      function updateDashboard(data) {
        const performance = data.performance;
        const systemInfo = data.system_info;
        const trends = data.trends;
        const trainingHistory = data.training_history;

        // Update status banner
        const statusAlert = document.getElementById("statusAlert");
        if (data.rl_enabled) {
          statusAlert.className = "alert alert-custom alert-success";
          statusAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-3 fs-5"></i>
                        <div>
                            <strong>RL System Active</strong>
                            <div class="small opacity-75">Last updated: ${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
        } else {
          statusAlert.className = "alert alert-custom alert-warning";
          statusAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
                        <strong>RL System Disabled</strong>
                    </div>
                `;
        }

        // Update key metrics
        document.getElementById("avgReward").textContent =
          performance.avg_reward?.toFixed(2) || "0.00";
        document.getElementById("positiveRate").textContent =
          (performance.positive_interaction_rate?.toFixed(1) || "0.0") + "%";
        document.getElementById("trainingExamples").textContent =
          performance.total_training_examples || 0;
        document.getElementById("explorationRate").textContent =
          ((systemInfo.exploration_rate || 0) * 100).toFixed(0) + "%";

        // Update change indicators
        updateChangeIndicator("rewardChange", trends.reward_improvement);
        updateChangeIndicator("positiveChange", trends.ctr_improvement);

        // Update system configuration
        document.getElementById("rlStatus").className = data.rl_enabled
          ? "status-badge status-enabled"
          : "status-badge status-disabled";
        document.getElementById(
          "rlStatus"
        ).innerHTML = `<i class="bi bi-circle-fill me-1"></i>${
          data.rl_enabled ? "Enabled" : "Disabled"
        }`;
        document.getElementById("similarityWeight").textContent =
          ((systemInfo.similarity_weight || 0) * 100).toFixed(0) + "%";
        document.getElementById("banditWeight").textContent =
          ((systemInfo.bandit_weight || 0) * 100).toFixed(0) + "%";

        // Update last training
        if (trainingHistory && trainingHistory.length > 0) {
          const lastTraining = new Date(trainingHistory[0].training_date);
          document.getElementById("lastTraining").textContent =
            lastTraining.toLocaleDateString();
        }

        // Update charts
        updateRewardChart(trainingHistory);
        updateCTRChart(trainingHistory);

        // Update top projects
        updateTopProjects(performance.top_projects);

        // Update training history table
        updateTrainingHistory(trainingHistory);
      }

      function updateChangeIndicator(elementId, value) {
        const element = document.getElementById(elementId);
        if (value === undefined || value === null || value === 0) {
          element.className = "stat-change neutral";
          element.innerHTML = '<i class="bi bi-dash"></i> No change';
        } else if (value > 0) {
          element.className = "stat-change positive";
          element.innerHTML = `<i class="bi bi-arrow-up"></i> +${value.toFixed(
            1
          )}%`;
        } else {
          element.className = "stat-change negative";
          element.innerHTML = `<i class="bi bi-arrow-down"></i> ${value.toFixed(
            1
          )}%`;
        }
      }

      function updateRewardChart(history) {
        const ctx = document
          .getElementById("rewardTrendChart")
          .getContext("2d");

        if (rewardChart) {
          rewardChart.destroy();
        }

        const data = history.slice().reverse();
        const labels = data.map((h) =>
          new Date(h.training_date).toLocaleDateString()
        );
        const preRewards = data.map((h) => h.pre_avg_reward || 0);
        const postRewards = data.map((h) => h.post_avg_reward || 0);

        rewardChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pre-Training",
                data: preRewards,
                borderColor: "#9a6700", // GitHub Orange
                backgroundColor: "rgba(154, 103, 0, 0.1)",
                tension: 0.3,
                borderWidth: 2
              },
              {
                label: "Post-Training",
                data: postRewards,
                borderColor: "#2da44e", // GitHub Green
                backgroundColor: "rgba(45, 164, 78, 0.1)",
                tension: 0.3,
                borderWidth: 2
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' }
              },
              x: {
                grid: { display: false }
              }
            },
          },
        });
      }

      function updateCTRChart(history) {
        const ctx = document.getElementById("ctrTrendChart").getContext("2d");

        if (ctrChart) {
          ctrChart.destroy();
        }

        const data = history.slice().reverse();
        const labels = data.map((h) =>
          new Date(h.training_date).toLocaleDateString()
        );
        const ctrValues = data.map((h) => h.post_avg_ctr || 0);

        ctrChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "CTR %",
                data: ctrValues,
                backgroundColor: "#0969da", // GitHub Blue
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              x: {
                grid: { display: false }
              }
            },
          },
        });
      }

      function updateTopProjects(projects) {
        const tbody = document
          .getElementById("topProjectsTable")
          .querySelector("tbody");

        if (!projects || projects.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-muted">No project data available yet</td></tr>';
          return;
        }

        tbody.innerHTML = projects
          .map((project, index) => {
            const rank = index + 1;
            const rankClass =
              rank === 1
                ? "rank-1"
                : rank === 2
                ? "rank-2"
                : rank === 3
                ? "rank-3"
                : "rank-other";
            const successRate = project.success_rate || 0;
            const totalInteractions = project.total_interactions || 0;
            const avgReward = project.avg_reward || 0;

            return `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td><strong>${
                          project.title || "Unknown Project"
                        }</strong></td>
                        <td>
                            <div class="progress" style="height: 6px; background-color: #f0f0f0;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: ${successRate}%; background-color: #2da44e !important;"
                                     aria-valuenow="${successRate}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem">${successRate.toFixed(1)}%</small>
                        </td>
                        <td>${totalInteractions}</td>
                        <td><span class="badge" style="background-color: #0969da">${avgReward.toFixed(
                          2
                        )}</span></td>
                    </tr>
                `;
          })
          .join("");
      }

      function updateTrainingHistory(history) {
        const tbody = document
          .getElementById("trainingHistoryTable")
          .querySelector("tbody");

        if (!history || history.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center py-3 text-muted">No training history available</td></tr>';
          return;
        }

        tbody.innerHTML = history
          .slice(0, 10)
          .map((record) => {
            const date = new Date(record.training_date).toLocaleDateString();
            const improvement = record.reward_improvement || 0;
            const improvementClass =
              improvement > 0
                ? "text-success"
                : improvement < 0
                ? "text-danger"
                : "text-muted";

            return `
                    <tr>
                        <td>${date}</td>
                        <td>${record.pre_avg_reward?.toFixed(2) || "0.00"}</td>
                        <td>${record.post_avg_reward?.toFixed(2) || "0.00"}</td>
                        <td class="${improvementClass}">
                            <strong>${
                              improvement > 0 ? "+" : ""
                            }${improvement.toFixed(2)}%</strong>
                        </td>
                        <td>${record.projects_updated || 0}</td>
                        <td class="text-muted small">${record.notes || "--"}</td>
                    </tr>
                `;
          })
          .join("");
      }

      async function triggerTraining() {
        if (
          !confirm(
            "Trigger manual RL training? This will process recent interactions and update the model."
          )
        ) {
          return;
        }

        document.getElementById("loadingOverlay").style.display = "flex";

        try {
          const response = await fetch("/api/admin/rl/trigger-training", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ days: currentPeriod }),
          });

          const result = await response.json();

          if (result.success) {
            alert(
              "Training completed successfully!\n\nAvg Reward: " +
                (result.performance.avg_reward || 0).toFixed(2)
            );
            loadRLPerformance();
          } else {
            alert("Training failed: " + result.error);
          }
        } catch (error) {
          console.error("Error triggering training:", error);
          alert("Failed to trigger training: " + error.message);
        } finally {
          document.getElementById("loadingOverlay").style.display = "none";
        }
      }

      function showError(message) {
        const statusAlert = document.getElementById("statusAlert");
        statusAlert.className = "alert alert-custom alert-danger";
        statusAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
                    <strong>Error: ${message}</strong>
                </div>
            `;
      }
    </script>
  </body>
</html>