{% extends "base.html" %} 
{% block title %}GitHub Project Inspiration - CoChain.ai{% endblock %} 

{% block content %}
<!-- Custom CSS for Shooting Stars -->
<style>
  /* Night Sky Background */
  .night-sky-bg {
    background: linear-gradient(to bottom, #0f172a, #1e293b, #0f172a);
  }

  /* Star styling */
  .star {
    position: absolute;
    top: 50%;
    left: 50%;
    height: 2px;
    background: linear-gradient(-45deg, #5f91ff, rgba(0, 0, 255, 0));
    filter: drop-shadow(0 0 6px #699bff);
    animation: tail 3000ms ease-in-out infinite, shooting 3000ms ease-in-out infinite;
    opacity: 0;
    z-index: -1;
  }

  /* The glowing head of the star */
  .star::before {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* The trail of the star */
  .star::after {
    content: '';
    position: absolute;
    top: calc(50% - 1px);
    right: 0;
    height: 2px;
    background: linear-gradient(-45deg, rgba(0, 0, 255, 0), #5f91ff, rgba(0, 0, 255, 0));
    transform: translateX(50%) rotateZ(45deg);
    border-radius: 100%;
    animation: shining 3000ms ease-in-out infinite;
  }

  /* Animations */
  @keyframes tail {
    0% { width: 0; }
    30% { width: 100px; }
    100% { width: 0; }
  }

  @keyframes shooting {
    0% { transform: translateX(0); }
    100% { transform: translateX(300px); }
  }

  @keyframes shining {
    0% { width: 0; }
    50% { width: 30px; }
    100% { width: 0; }
  }
  
  /* Twinkling static stars (optional dots in background) */
  .static-star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--duration) ease-in-out infinite;
    opacity: var(--opacity);
  }
  
  @keyframes twinkle {
    0%, 100% { opacity: var(--opacity); transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
  }
</style>

<!-- BACKGROUND CONTAINER (Fixed position, behind everything) -->
<div class="fixed inset-0 night-sky-bg overflow-hidden pointer-events-none" style="z-index: -1;">
  <div id="star-container"></div>
  <div id="static-star-container"></div>
</div>

<!-- CONTENT WRAPPER (Relative position to sit on top of stars) -->
<div class="min-h-screen relative z-10">
  
  <!-- Header -->
  <div class="bg-white/95 backdrop-blur-sm shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">
          <i class="fab fa-github mr-2"></i>GitHub Project Inspiration
        </h1>
        <div class="flex space-x-4">
          <a
            href="{{ url_for('live_projects') }}"
            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition font-medium border border-green-700 shadow-md"
          >
            <i class="fas fa-users mr-2"></i>Live Projects
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Welcome Message -->
    <div
      class="bg-gray-900 text-white rounded-md p-6 mb-8 border border-gray-700 shadow-lg relative overflow-hidden"
    >
      <!-- Decorative element for the welcome card -->
      <div class="absolute top-0 right-0 w-32 h-32 bg-blue-600 rounded-full filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
      
      <div class="relative z-10">
        <h2 class="text-xl font-semibold mb-2">Welcome back, {{ user_name }}!</h2>
        <p class="text-gray-300">
          Here are GitHub projects tailored to your interests and skills
        </p>
      </div>
    </div>

    <!-- Filter Options -->
    <div class="bg-white rounded-md shadow-lg p-6 mb-8 border border-gray-200">
      <h3 class="text-lg font-semibold mb-4 text-gray-900">Filter by Interest</h3>
      <div class="flex flex-wrap gap-3">
        <button
          id="filter-all"
          class="filter-btn bg-blue-600 text-white px-4 py-1.5 rounded-full hover:bg-blue-700 transition active text-sm font-medium shadow-sm"
          data-filter="all"
        >
          All
        </button>
        {% if user_interests and user_interests|length > 0 %} {% for interest in
        user_interests %}
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="{{ interest }}"
        >
          {{ interest.replace('_', ' ').title() }}
        </button>
        {% endfor %} {% else %}
        <!-- Default interests if user hasn't set any -->
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="web_development"
        >
          Web Development
        </button>
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="machine_learning"
        >
          Machine Learning
        </button>
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="mobile_development"
        >
          Mobile Apps
        </button>
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="data_science"
        >
          Data Science
        </button>
        <button
          class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full hover:bg-gray-200 hover:text-blue-600 transition text-sm font-medium"
          data-filter="devops"
        >
          DevOps
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Recommended Projects -->
    <div
      id="projects-container"
      class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
    >
      {% if recommendations and recommendations|length > 0 %} {% for project in
      recommendations %}
      <div
        class="project-card bg-white rounded-md shadow-md border border-gray-200 hover:border-blue-400 hover:shadow-lg transition p-6 transform hover:-translate-y-1 duration-200"
        data-project-id="{{ project.id }}"
        data-position="{{ loop.index }}"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div
              class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center border border-gray-200"
            >
              <i class="fab fa-github text-gray-700"></i>
            </div>
            <div>
              <h4 class="font-semibold text-blue-600 hover:underline cursor-pointer">
                {{ project.title[:50] }}{% if project.title|length > 50 %}...{%
                endif %}
              </h4>
              <p class="text-xs text-gray-500">
                {{ project.source or 'GitHub' }}
              </p>
            </div>
          </div>
          <button
            class="bookmark-btn text-gray-400 hover:text-gray-600 transition"
            data-project-id="{{ project.id }}"
            data-position="{{ loop.index }}"
            data-similarity="{{ project.similarity or 0 }}"
            onclick="toggleBookmark('{{ project.id }}', {{ loop.index }}, {{ project.similarity or 0 }}, this)"
          >
            <i class="far fa-bookmark"></i>
          </button>
        </div>

        <p class="text-gray-600 mb-4 text-sm leading-relaxed">
          {{ project.description[:150] }}{% if project.description and
          project.description|length > 150 %}...{% endif %}
        </p>

        <div class="flex flex-wrap gap-2 mb-4">
          {% if project.similarity %}
          <span class="bg-green-100 text-green-700 border border-green-200 text-xs px-2 py-0.5 rounded-full font-medium">
            {{ (project.similarity * 100)|int }}% Match
          </span>
          {% endif %} {% if project.domain %}
          <span class="bg-blue-100 text-blue-700 border border-blue-200 text-xs px-2 py-0.5 rounded-full font-medium">
            {{ project.domain }}
          </span>
          {% endif %} {% if project.complexity_level %}
          <span class="bg-purple-100 text-purple-700 border border-purple-200 text-xs px-2 py-0.5 rounded-full font-medium">
            {{ project.complexity_level }}
          </span>
          {% endif %}
        </div>

        <div class="flex items-center justify-between text-xs text-gray-500 mt-auto">
          <div class="flex items-center space-x-3">
             <span class="flex items-center hover:text-blue-600 transition cursor-default">
                <i class="far fa-star mr-1"></i>{{ project.original_stars or 0 }}
             </span>
             <span class="flex items-center hover:text-blue-600 transition cursor-default">
                <i class="fas fa-code-branch mr-1"></i>{{ project.original_forks or 0 }}
             </span>
          </div>
          {% if project.repository_url %}
          <a
            href="{{ project.repository_url }}"
            target="_blank"
            class="text-gray-600 hover:text-blue-600 font-semibold github-link bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-md border border-gray-200 transition"
            onclick="trackGitHubClick('{{ project.id }}', {{ loop.index }})"
          >
            View Repo
          </a>
          {% else %}
          <span class="text-gray-400">No URL</span>
          {% endif %}
        </div>
      </div>
      {% endfor %} {% else %}
      <!-- No recommendations available -->
      <div class="col-span-full text-center py-12 bg-white rounded-lg shadow-md p-6">
        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">
          No recommendations yet
        </h3>
        <p class="text-gray-500 mb-4">
          Complete your profile to get personalized project recommendations
        </p>
        <a
          href="{{ url_for('profile_setup') }}"
          class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition font-medium"
        >
          Update Profile
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Loading More -->
    {% if recommendations and recommendations|length > 0 %}
    <div id="load-more-container" class="text-center mt-8 pb-8">
      <button
        id="load-more-btn"
        class="bg-white text-blue-600 border border-gray-300 px-6 py-2 rounded-md hover:bg-gray-50 transition font-semibold shadow-md"
        onclick="loadMoreRecommendations()"
      >
        Load More Projects
      </button>
      <div id="loading-indicator" class="hidden mt-4 bg-white inline-block px-4 py-2 rounded-full shadow-lg">
        <i class="fas fa-spinner fa-spin text-gray-500"></i>
        <span class="ml-2 text-gray-600">Loading more recommendations...</span>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script>
  /**
   * Initialize dashboard functionality
   */
  document.addEventListener('DOMContentLoaded', function() {
      initializeFilters();
      updateLoadMoreButton();
      checkBookmarkedProjects();
      createShootingStars(); // Initialize animation
  });

  /**
   * Create Shooting Stars Background Effect
   */
  function createShootingStars() {
      const starContainer = document.getElementById('star-container');
      const staticContainer = document.getElementById('static-star-container');
      const starCount = 15; // Number of shooting stars
      const staticCount = 50; // Number of background twinkling stars
      
      // 1. Create Shooting Stars
      for (let i = 0; i < starCount; i++) {
          const star = document.createElement('span');
          star.className = 'star';
          
          // Random positioning
          const top = Math.random() * 100;
          const left = Math.random() * 100;
          
          // Random delay/duration for natural feel
          const delay = Math.random() * 5000;
          const duration = 3000 + Math.random() * 3000;
          
          star.style.top = top + '%';
          star.style.left = left + '%';
          star.style.width = (Math.random() * 100 + 100) + 'px'; // Random trail length
          star.style.animationDelay = delay + 'ms';
          star.style.animationDuration = duration + 'ms';
          
          // Rotation logic to make them fall diagonally
          star.style.transform = 'rotateZ(45deg)';
          
          starContainer.appendChild(star);
      }

      // 2. Create Static Twinkling Stars
      for (let i = 0; i < staticCount; i++) {
          const dot = document.createElement('div');
          dot.className = 'static-star';
          
          const size = Math.random() * 2 + 1; // 1px to 3px
          
          dot.style.width = size + 'px';
          dot.style.height = size + 'px';
          dot.style.top = Math.random() * 100 + '%';
          dot.style.left = Math.random() * 100 + '%';
          
          // Custom properties for CSS animation
          dot.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
          dot.style.setProperty('--opacity', Math.random() * 0.5 + 0.1);
          
          staticContainer.appendChild(dot);
      }
  }

  // --- EXISTING JAVASCRIPT LOGIC BELOW ---

  // Global state
  let currentFilter = 'all';
  let currentCount = {{ recommendations|length if recommendations else 0 }};
  const maxRecommendations = 15;
  let isLoadingMore = false; 

  /**
   * Initialize filter buttons
   */
  function initializeFilters() {
      const filterButtons = document.querySelectorAll('.filter-btn');

      filterButtons.forEach(button => {
          button.addEventListener('click', function() {
              filterButtons.forEach(btn => {
                  btn.classList.remove('bg-blue-600', 'text-white', 'active');
                  btn.classList.add('bg-gray-100', 'text-gray-600');
              });

              this.classList.remove('bg-gray-100', 'text-gray-600');
              this.classList.add('bg-blue-600', 'text-white', 'active');

              currentFilter = this.dataset.filter || 'all';
              filterProjects(currentFilter);
          });
      });
  }

  function filterProjects(filterValue) {
      const projectCards = document.querySelectorAll('.project-card');

      projectCards.forEach(card => {
          if (filterValue === 'all') {
              card.style.display = 'block';
          } else {
              const cardText = card.textContent.toLowerCase();
              const filterText = filterValue.replace('_', ' ').toLowerCase();

              card.style.display = cardText.includes(filterText) ? 'block' : 'none';
          }
      });
  }

  function toggleBookmark(projectId, position, similarity, buttonElement) {
      const icon = buttonElement.querySelector('i');
      const wasBookmarked = buttonElement.classList.contains('text-yellow-500');

      icon.className = 'fas fa-spinner fa-spin';
      buttonElement.disabled = true;

      fetch('/api/bookmark', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              github_reference_id: projectId,
              position: position,              
              similarity: similarity,           
              session_id: '{{ session.get("session_id", "") }}'
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              if (data.action === 'added') {
                  icon.className = 'fas fa-bookmark';
                  buttonElement.classList.remove('text-gray-400', 'text-gray-600');
                  buttonElement.classList.add('text-yellow-500'); 
                  buttonElement.title = 'Remove from bookmarks';
                  showToast('Project bookmarked!', 'success');
              } else if (data.action === 'removed') {
                  icon.className = 'far fa-bookmark';
                  buttonElement.classList.remove('text-yellow-500');
                  buttonElement.classList.add('text-gray-400');
                  buttonElement.title = 'Add to bookmarks';
                  showToast('Bookmark removed', 'info');
              }
          } else {
              icon.className = 'far fa-bookmark';
              console.error('Error toggling bookmark:', data.error);
              showToast('Failed to update bookmark', 'error');
          }
      })
      .catch(error => {
          icon.className = 'far fa-bookmark';
          console.error('Error toggling bookmark:', error);
          showToast('Failed to update bookmark', 'error');
      })
      .finally(() => {
          buttonElement.disabled = false;
      });
  }

  function trackGitHubClick(projectId, position) {
      fetch('/api/recommendation/click', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              github_reference_id: projectId,
              rank_position: position,  
              similarity_score: 0.0,    
              session_id: '{{ session.get("session_id", "") }}'  
          })
      }).then(response => {
          if (response.ok) {
              console.log('Click tracked successfully');
          }
      }).catch(error => console.error('Error tracking click:', error));
  }

  function loadMoreRecommendations() {
      if (isLoadingMore) return;

      if (currentCount >= maxRecommendations) {
          showToast('Maximum recommendations reached', 'info');
          return;
      }

      isLoadingMore = true; 
      const loadMoreBtn = document.getElementById('load-more-btn');
      const loadingIndicator = document.getElementById('loading-indicator');

      loadMoreBtn.style.display = 'none';
      loadingIndicator.classList.remove('hidden');

      fetch('/api/recommendations/load-more', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              current_count: currentCount,
              filter: currentFilter === 'all' ? null : currentFilter
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success && data.recommendations && data.recommendations.length > 0) {
              const projectsContainer = document.getElementById('projects-container');

              data.recommendations.forEach((project, index) => {
                  const position = currentCount + index + 1;
                  const projectCard = createProjectCard(project, position);
                  projectsContainer.appendChild(projectCard);
              });

              currentCount += data.recommendations.length;
              updateLoadMoreButton();

              if (currentFilter !== 'all') {
                  filterProjects(currentFilter);
              }

              showToast(`Loaded ${data.recommendations.length} more projects`, 'success');
          } else {
              updateLoadMoreButton();
              showToast('No more recommendations available', 'info');
          }
      })
      .catch(error => {
          console.error('Error loading more recommendations:', error);
          showToast('Failed to load more recommendations', 'error');
      })
      .finally(() => {
          isLoadingMore = false; 
          loadingIndicator.classList.add('hidden');
          loadMoreBtn.style.display = 'inline-block';
      });
  }

  function updateLoadMoreButton() {
      const loadMoreContainer = document.getElementById('load-more-container');
      if (!loadMoreContainer) return;
      const projectCards = document.querySelectorAll('.project-card');
      const hasProjects = projectCards.length > 0;

      if (currentCount >= maxRecommendations) {
          loadMoreContainer.style.display = 'none';
      } else if (currentCount === 0 && !hasProjects) {
          loadMoreContainer.style.display = 'none';
      } else if (hasProjects && currentCount < maxRecommendations) {
          loadMoreContainer.style.display = 'block';
      } else {
          loadMoreContainer.style.display = 'none';
      }
  }

  function createProjectCard(project, position) {
      const div = document.createElement('div');
      // Added shadow-md and hover effects for the dark background
      div.className = 'project-card bg-white rounded-md shadow-md border border-gray-200 hover:border-blue-400 hover:shadow-lg transition p-6 transform hover:-translate-y-1 duration-200';
      div.dataset.projectId = project.id;
      div.dataset.position = position;

      const matchBadge = project.similarity ?
          `<span class="bg-green-100 text-green-700 border border-green-200 text-xs px-2 py-0.5 rounded-full font-medium">${Math.round(project.similarity * 100)}% Match</span>` : '';

      const domainBadge = project.domain ?
          `<span class="bg-blue-100 text-blue-700 border border-blue-200 text-xs px-2 py-0.5 rounded-full font-medium">${project.domain}</span>` : '';

      const complexityBadge = project.complexity_level ?
          `<span class="bg-purple-100 text-purple-700 border border-purple-200 text-xs px-2 py-0.5 rounded-full font-medium">${project.complexity_level}</span>` : '';

      div.innerHTML = `
          <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center border border-gray-200">
                      <i class="fab fa-github text-gray-700"></i>
                  </div>
                  <div>
                      <h4 class="font-semibold text-blue-600 hover:underline cursor-pointer">${escapeHtml((project.title || '').substring(0, 50))}${project.title && project.title.length > 50 ? '...' : ''}</h4>
                      <p class="text-xs text-gray-500">${project.source || 'GitHub'}</p>
                  </div>
              </div>
              <button class="bookmark-btn text-gray-400 hover:text-gray-600 transition"
                      data-project-id="${project.id}"
                      data-position="${position}"
                      data-similarity="${project.similarity || 0}"
                      onclick="toggleBookmark('${project.id}', ${position}, ${project.similarity || 0}, this)">
                  <i class="far fa-bookmark"></i>
              </button>
          </div>

          <p class="text-gray-600 mb-4 text-sm leading-relaxed">${escapeHtml((project.description || '').substring(0, 150))}${project.description && project.description.length > 150 ? '...' : ''}</p>

          <div class="flex flex-wrap gap-2 mb-4">
              ${matchBadge}
              ${domainBadge}
              ${complexityBadge}
          </div>

          <div class="flex items-center justify-between text-xs text-gray-500 mt-auto">
              <div class="flex items-center space-x-3">
                  <span class="flex items-center hover:text-blue-600 transition cursor-default"><i class="far fa-star mr-1"></i>${project.original_stars || 0}</span>
                  <span class="flex items-center hover:text-blue-600 transition cursor-default"><i class="fas fa-code-branch mr-1"></i>${project.original_forks || 0}</span>
              </div>
              ${project.repository_url ?
                  `<a href="${project.repository_url}" target="_blank"
                      class="text-gray-600 hover:text-blue-600 font-semibold github-link bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-md border border-gray-200 transition"
                      onclick="trackGitHubClick('${project.id}', ${position})">View Repo</a>` :
                  '<span class="text-gray-400">No URL</span>'
              }
          </div>
      `;

      return div;
  }

  function checkBookmarkedProjects() {
      // API call placeholder
  }

  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'transform transition-all duration-300 translate-x-full mb-4';
      let bgColor = 'bg-green-600'; 
      let icon = 'fa-check-circle';

      if (type === 'error') {
          bgColor = 'bg-red-600'; icon = 'fa-exclamation-circle';
      } else if (type === 'info') {
          bgColor = 'bg-blue-600'; icon = 'fa-info-circle';
      } else if (type === 'warning') {
          bgColor = 'bg-yellow-500'; icon = 'fa-exclamation-triangle';
      }

      toast.innerHTML = `
          <div class="${bgColor} text-white px-6 py-3 rounded-md shadow-lg flex items-center space-x-3 border border-transparent">
              <i class="fas ${icon}"></i>
              <span class="font-medium text-sm">${escapeHtml(message)}</span>
          </div>
      `;
      container.appendChild(toast);
      setTimeout(() => { toast.classList.remove('translate-x-full'); }, 10);
      setTimeout(() => {
          toast.classList.add('translate-x-full');
          setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
  }

  function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
  }
</script>

{% endblock %}