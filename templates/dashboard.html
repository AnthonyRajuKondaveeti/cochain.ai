{% extends "base.html" %}
{% block title %}GitHub Project Inspiration - CoChain.ai{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">
          <i class="fab fa-github mr-2"></i>GitHub Project Inspiration
        </h1>
        <div class="flex space-x-4">
          <a
            href="{{ url_for('live_projects') }}"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
          >
            <i class="fas fa-users mr-2"></i>Live Projects
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Welcome Message -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold mb-2">Welcome back, {{ user_name }}!</h2>
      <p class="opacity-90">
        Here are GitHub projects tailored to your interests and skills
      </p>
    </div>

    <!-- Filter Options -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">Filter by Interest</h3>
      <div class="flex flex-wrap gap-3">
        <button
          id="filter-all"
          class="filter-btn bg-blue-100 text-blue-800 px-4 py-2 rounded-full hover:bg-blue-200 transition active"
          data-filter="all"
        >
          All
        </button>
        {% if user_interests and user_interests|length > 0 %}
          {% for interest in user_interests %}
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="{{ interest }}"
          >
            {{ interest.replace('_', ' ').title() }}
          </button>
          {% endfor %}
        {% else %}
          <!-- Default interests if user hasn't set any -->
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="web_development"
          >
            Web Development
          </button>
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="machine_learning"
          >
            Machine Learning
          </button>
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="mobile_development"
          >
            Mobile Apps
          </button>
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="data_science"
          >
            Data Science
          </button>
          <button
            class="filter-btn bg-gray-100 text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200 transition"
            data-filter="devops"
          >
            DevOps
          </button>
        {% endif %}
      </div>
    </div>

    <!-- Recommended Projects -->
    <div id="projects-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% if recommendations and recommendations|length > 0 %}
        {% for project in recommendations %}
        <div
          class="project-card bg-white rounded-lg shadow-sm border hover:shadow-md transition p-6"
          data-project-id="{{ project.id }}"
          data-position="{{ loop.index }}"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                <i class="fab fa-github text-gray-600"></i>
              </div>
              <div>
                <h4 class="font-semibold text-gray-900">
                  {{ project.title[:50] }}{% if project.title|length > 50 %}...{% endif %}
                </h4>
                <p class="text-sm text-gray-500">
                  {{ project.source or 'GitHub' }}
                </p>
              </div>
            </div>
            <button
              class="bookmark-btn text-gray-400 hover:text-yellow-500 transition"
              data-project-id="{{ project.id }}"
              data-position="{{ loop.index }}"
              data-similarity="{{ project.similarity or 0 }}"
              onclick="toggleBookmark('{{ project.id }}', {{ loop.index }}, {{ project.similarity or 0 }}, this)"
            >
              <i class="fas fa-bookmark"></i>
            </button>
          </div>

          <p class="text-gray-600 mb-4">
            {{ project.description[:150] }}{% if project.description and project.description|length > 150 %}...{% endif %}
          </p>

          <div class="flex flex-wrap gap-2 mb-4">
            {% if project.similarity %}
            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
              {{ (project.similarity * 100)|int }}% Match
            </span>
            {% endif %}
            {% if project.domain %}
            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
              {{ project.domain }}
            </span>
            {% endif %}
            {% if project.complexity_level %}
            <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">
              {{ project.complexity_level }}
            </span>
            {% endif %}
          </div>

          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>
              <i class="fas fa-star mr-1"></i>{{ project.original_stars or 0 }} stars
            </span>
            <span>
              <i class="fas fa-code-branch mr-1"></i>{{ project.original_forks or 0 }} forks
            </span>
            {% if project.repository_url %}
            <a
              href="{{ project.repository_url }}"
              target="_blank"
              class="text-blue-600 hover:text-blue-800 font-medium github-link"
              onclick="trackGitHubClick('{{ project.id }}', {{ loop.index }})"
            >
              View Project
            </a>
            {% else %}
            <span class="text-gray-400">No URL</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <!-- No recommendations available -->
        <div class="col-span-full text-center py-12">
          <i class="fas fa-search text-gray-400 text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">
            No recommendations yet
          </h3>
          <p class="text-gray-500 mb-4">
            Complete your profile to get personalized project recommendations
          </p>
          <a
            href="{{ url_for('profile_setup') }}"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
          >
            Update Profile
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Loading More -->
    {% if recommendations and recommendations|length > 0 %}
    <div id="load-more-container" class="text-center mt-8">
      <button
        id="load-more-btn"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
        onclick="loadMoreRecommendations()"
      >
        Load More Projects
      </button>
      <div id="loading-indicator" class="hidden mt-4">
        <i class="fas fa-spinner fa-spin text-blue-600"></i>
        <span class="ml-2 text-gray-600">Loading more recommendations...</span>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script>
/**
 * Dashboard JavaScript
 * Handles filtering, bookmarks, and loading more recommendations
 */

// Global state
let currentFilter = 'all';
let currentCount = {{ recommendations|length if recommendations else 0 }};
const maxRecommendations = 15;
let isLoadingMore = false; // Prevent multiple simultaneous requests

/**
 * Initialize dashboard functionality
 */
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    updateLoadMoreButton();
    checkBookmarkedProjects();
});

/**
 * Initialize filter buttons
 */
function initializeFilters() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-800', 'active');
                btn.classList.add('bg-gray-100', 'text-gray-800');
            });

            // Add active class to clicked button
            this.classList.remove('bg-gray-100', 'text-gray-800');
            this.classList.add('bg-blue-100', 'text-blue-800', 'active');

            // Get filter value and apply
            currentFilter = this.dataset.filter || 'all';
            filterProjects(currentFilter);
        });
    });
}

/**
 * Filter projects by interest
 */
function filterProjects(filterValue) {
    const projectCards = document.querySelectorAll('.project-card');

    projectCards.forEach(card => {
        if (filterValue === 'all') {
            card.style.display = 'block';
        } else {
            const cardText = card.textContent.toLowerCase();
            const filterText = filterValue.replace('_', ' ').toLowerCase();
            
            card.style.display = cardText.includes(filterText) ? 'block' : 'none';
        }
    });
}

/**
 * Toggle bookmark status
 */
function toggleBookmark(projectId, position, similarity, buttonElement) {
    const icon = buttonElement.querySelector('i');
    const wasBookmarked = buttonElement.classList.contains('text-yellow-500');

    // Show loading state
    icon.className = 'fas fa-spinner fa-spin';
    buttonElement.disabled = true;

    fetch('/api/bookmark', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            github_reference_id: projectId,
            position: position,              // Add position for RL tracking
            similarity: similarity,           // Add similarity for RL tracking
            session_id: '{{ session.get("session_id", "") }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            icon.className = 'fas fa-bookmark';

            if (data.action === 'added') {
                buttonElement.classList.remove('text-gray-400');
                buttonElement.classList.add('text-yellow-500');
                buttonElement.title = 'Remove from bookmarks';
                showToast('Project bookmarked!', 'success');
                
                // Log bookmark for debugging
                console.log('Bookmark added:', projectId, 'at position:', position);
            } else if (data.action === 'removed') {
                buttonElement.classList.remove('text-yellow-500');
                buttonElement.classList.add('text-gray-400');
                buttonElement.title = 'Add to bookmarks';
                showToast('Bookmark removed', 'info');
            }
        } else {
            icon.className = 'fas fa-bookmark';
            console.error('Error toggling bookmark:', data.error);
            showToast('Failed to update bookmark', 'error');
        }
    })
    .catch(error => {
        icon.className = 'fas fa-bookmark';
        console.error('Error toggling bookmark:', error);
        showToast('Failed to update bookmark', 'error');
    })
    .finally(() => {
        buttonElement.disabled = false;
    });
}

/**
 * Track GitHub link clicks
 */
function trackGitHubClick(projectId, position) {
    // Send tracking event (fire and forget)
    fetch('/api/recommendation/click', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            github_reference_id: projectId,
            rank_position: position,  // Fixed: backend expects rank_position
            similarity_score: 0.0,    // Added: required by backend
            session_id: '{{ session.get("session_id", "") }}'  // Added: track session
        })
    }).then(response => {
        if (response.ok) {
            console.log('Click tracked successfully for project:', projectId, 'at position:', position);
        }
    }).catch(error => {
        console.error('Error tracking click:', error);
    });
}

/**
 * Load more recommendations
 */
function loadMoreRecommendations() {
    // Prevent multiple simultaneous requests
    if (isLoadingMore) {
        console.log('Already loading recommendations, please wait...');
        return;
    }
    
    if (currentCount >= maxRecommendations) {
        showToast('Maximum recommendations reached', 'info');
        return;
    }

    isLoadingMore = true; // Set loading flag
    const loadMoreBtn = document.getElementById('load-more-btn');
    const loadingIndicator = document.getElementById('loading-indicator');

    // Show loading state
    loadMoreBtn.style.display = 'none';
    loadingIndicator.classList.remove('hidden');

    fetch('/api/recommendations/load-more', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_count: currentCount,
            filter: currentFilter === 'all' ? null : currentFilter
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.recommendations && data.recommendations.length > 0) {
            const projectsContainer = document.getElementById('projects-container');

            data.recommendations.forEach((project, index) => {
                const position = currentCount + index + 1;
                const projectCard = createProjectCard(project, position);
                projectsContainer.appendChild(projectCard);
            });

            currentCount += data.recommendations.length;
            updateLoadMoreButton();

            // Apply current filter to new projects
            if (currentFilter !== 'all') {
                filterProjects(currentFilter);
            }

            showToast(`Loaded ${data.recommendations.length} more projects`, 'success');
        } else {
            updateLoadMoreButton();
            showToast('No more recommendations available', 'info');
        }
    })
    .catch(error => {
        console.error('Error loading more recommendations:', error);
        showToast('Failed to load more recommendations', 'error');
    })
    .finally(() => {
        isLoadingMore = false; // Reset loading flag
        loadingIndicator.classList.add('hidden');
        loadMoreBtn.style.display = 'inline-block';
    });
}

/**
 * Update load more button visibility
 */
function updateLoadMoreButton() {
    const loadMoreContainer = document.getElementById('load-more-container');
    if (!loadMoreContainer) return;

    // Hide if we've reached max OR if initial load has 0 recommendations
    // Check if we have any project cards to determine if it's truly empty
    const projectCards = document.querySelectorAll('.project-card');
    const hasProjects = projectCards.length > 0;
    
    if (currentCount >= maxRecommendations) {
        loadMoreContainer.style.display = 'none';
    } else if (currentCount === 0 && !hasProjects) {
        // No recommendations at all - hide the load more button
        loadMoreContainer.style.display = 'none';
    } else if (hasProjects && currentCount < maxRecommendations) {
        // We have projects and haven't reached max - show button
        loadMoreContainer.style.display = 'block';
    } else {
        loadMoreContainer.style.display = 'none';
    }
}

/**
 * Create project card HTML element
 */
function createProjectCard(project, position) {
    const div = document.createElement('div');
    div.className = 'project-card bg-white rounded-lg shadow-sm border hover:shadow-md transition p-6';
    div.dataset.projectId = project.id;
    div.dataset.position = position;

    const matchBadge = project.similarity ? 
        `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${Math.round(project.similarity * 100)}% Match</span>` : '';
    
    const domainBadge = project.domain ? 
        `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${project.domain}</span>` : '';
    
    const complexityBadge = project.complexity_level ? 
        `<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">${project.complexity_level}</span>` : '';

    div.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <i class="fab fa-github text-gray-600"></i>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-900">${escapeHtml((project.title || '').substring(0, 50))}${project.title && project.title.length > 50 ? '...' : ''}</h4>
                    <p class="text-sm text-gray-500">${project.source || 'GitHub'}</p>
                </div>
            </div>
            <button class="bookmark-btn text-gray-400 hover:text-yellow-500 transition" 
                    data-project-id="${project.id}"
                    data-position="${position}"
                    data-similarity="${project.similarity || 0}"
                    onclick="toggleBookmark('${project.id}', ${position}, ${project.similarity || 0}, this)">
                <i class="fas fa-bookmark"></i>
            </button>
        </div>

        <p class="text-gray-600 mb-4">${escapeHtml((project.description || '').substring(0, 150))}${project.description && project.description.length > 150 ? '...' : ''}</p>

        <div class="flex flex-wrap gap-2 mb-4">
            ${matchBadge}
            ${domainBadge}
            ${complexityBadge}
        </div>

        <div class="flex items-center justify-between text-sm text-gray-500">
            <span><i class="fas fa-star mr-1"></i>${project.original_stars || 0} stars</span>
            <span><i class="fas fa-code-branch mr-1"></i>${project.original_forks || 0} forks</span>
            ${project.repository_url ?
                `<a href="${project.repository_url}" target="_blank" 
                    class="text-blue-600 hover:text-blue-800 font-medium github-link"
                    onclick="trackGitHubClick('${project.id}', ${position})">View Project</a>` :
                '<span class="text-gray-400">No URL</span>'
            }
        </div>
    `;

    return div;
}

/**
 * Check which projects are already bookmarked
 */
function checkBookmarkedProjects() {
    // This would require an API call to get user's bookmarks
    // For now, we'll skip this to avoid extra API calls on page load
    // You can implement this if needed
}

/**
 * Show toast notification
 */
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = 'transform transition-all duration-300 translate-x-full mb-4';
    
    let bgColor = 'bg-green-500';
    let icon = 'fa-check-circle';
    
    if (type === 'error') {
        bgColor = 'bg-red-500';
        icon = 'fa-exclamation-circle';
    } else if (type === 'info') {
        bgColor = 'bg-blue-500';
        icon = 'fa-info-circle';
    } else if (type === 'warning') {
        bgColor = 'bg-yellow-500';
        icon = 'fa-exclamation-triangle';
    }
    
    toast.innerHTML = `
        <div class="${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(message)}</span>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}